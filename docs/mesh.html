<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mesh</title>
    <meta name="theme-color" content="#0a0a0a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ•¸ï¸</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{
            --bg:#0a0a0a;--bg1:#111;--bg2:#161616;
            --glass:rgba(255,255,255,0.04);--glass-b:rgba(255,255,255,0.08);
            --t1:rgba(255,255,255,0.92);--t2:rgba(255,255,255,0.55);--t3:rgba(255,255,255,0.3);
            --accent:#ff9500;--green:#30d158;--red:#ff453a;--blue:#007aff;
            --purple:#bf5af2;--cyan:#00d4ff;--yellow:#ffd60a;--pink:#ff375f;
            --c-github:#f0883e;--c-agentcore:#bf5af2;--c-zenoh:#30d158;
            --c-local:#00ff88;--c-browser:#007aff;--c-virtual:#ff375f;
        }
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro',system-ui,sans-serif;background:var(--bg);color:var(--t1);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
        ::selection{background:rgba(255,255,255,0.15)}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}

        .app{display:flex;height:100vh}

        /* â”€â”€ SIDEBAR â”€â”€ */
        .sb{width:290px;background:var(--bg1);border-right:1px solid var(--glass-b);display:flex;flex-direction:column;flex-shrink:0}
        .sb-hdr{padding:14px 16px;border-bottom:1px solid var(--glass-b);display:flex;align-items:center;gap:10px}
        .sb-icon{font-size:26px}.sb-title{font-size:15px;font-weight:600;flex:1}.sb-sub{font-size:10px;color:var(--t3);display:flex;align-items:center;gap:5px;margin-top:1px}
        .dot{width:7px;height:7px;border-radius:50%;background:var(--red)}.dot.on{background:var(--green);animation:gl 2s infinite}.dot.wait{background:var(--yellow);animation:pl 1s infinite}
        @keyframes gl{0%,100%{box-shadow:0 0 4px var(--green)}50%{box-shadow:0 0 12px var(--green)}}
        @keyframes pl{0%,100%{opacity:1}50%{opacity:.4}}
        .sb-btn{width:30px;height:30px;border-radius:7px;background:var(--glass);border:1px solid var(--glass-b);color:var(--t3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .sb-btn:hover{background:rgba(255,255,255,.1);color:var(--t1)}

        .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;padding:10px 12px;border-bottom:1px solid var(--glass-b)}
        .st{text-align:center;padding:5px 2px;background:var(--glass);border-radius:6px}
        .st-v{font-size:16px;font-weight:700}.st-l{font-size:6px;text-transform:uppercase;letter-spacing:.04em;color:var(--t3);margin-top:1px}

        .sb-scroll{flex:1;overflow-y:auto;padding:10px}
        .sec-hdr{display:flex;align-items:center;gap:6px;margin:10px 0 6px;padding:0 4px}
        .sec-icon{font-size:12px}.sec-title{font-size:9px;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);font-weight:600;flex:1}
        .sec-cnt{font-size:9px;color:var(--t2);background:var(--glass);padding:1px 6px;border-radius:8px}

        .ac{background:var(--bg2);border:1px solid var(--glass-b);border-radius:9px;padding:10px;margin-bottom:6px;cursor:pointer;transition:all .15s}
        .ac:hover{border-color:rgba(255,255,255,.15);transform:translateY(-1px)}
        .ac.active{border-color:var(--accent);background:rgba(255,149,0,.08)}
        .ac.selected{border-color:var(--green);background:rgba(48,209,88,.06)}
        .ac.selected.active{border-color:var(--accent)}
        .ac-sel{width:14px;height:14px;border-radius:4px;border:1.5px solid var(--t3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .15s}
        .ac.selected .ac-sel{border-color:var(--green);background:var(--green);color:#000}
        .ac-hdr{display:flex;align-items:center;gap:8px}
        .ac-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .ac-info{flex:1;min-width:0}.ac-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .ac-meta{font-size:9px;color:var(--t3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .badge{font-size:7px;padding:2px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.03em;font-weight:600}
        .badge.github{background:rgba(240,136,62,.2);color:var(--c-github)}.badge.agentcore{background:rgba(191,90,242,.2);color:var(--c-agentcore)}
        .badge.zenoh{background:rgba(48,209,88,.2);color:var(--c-zenoh)}.badge.local{background:rgba(0,255,136,.2);color:var(--c-local)}
        .badge.browser{background:rgba(0,122,255,.2);color:var(--c-browser)}.badge.virtual{background:rgba(255,55,95,.2);color:var(--c-virtual)}
        .ac-st{font-size:7px;padding:2px 5px;border-radius:3px;margin-left:3px}
        .ac-st.ready{background:rgba(48,209,88,.15);color:var(--green)}.ac-st.streaming{background:rgba(48,209,88,.15);color:var(--green);animation:pl 1s infinite}
        .ac-st.running{background:rgba(255,214,10,.15);color:var(--yellow)}.ac-st.failed{background:rgba(255,69,58,.15);color:var(--red)}
        .ac-acts{display:none;gap:3px;margin-left:auto}
        .ac:hover .ac-acts,.ac.active .ac-acts{display:flex}
        .ac-ab{width:20px;height:20px;border-radius:4px;background:0;border:1px solid var(--glass-b);color:var(--t3);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .ac-ab:hover{background:rgba(255,255,255,.1);color:var(--t1)}
        .ac-ab.del:hover{background:rgba(255,69,58,.15);color:var(--red)}

        .sb-spawn{display:flex;gap:4px;padding:8px 12px;border-top:1px solid var(--glass-b)}
        .spawn-btn{flex:1;padding:8px;background:var(--glass);border:1px dashed var(--glass-b);border-radius:7px;color:var(--t3);font-size:10px;cursor:pointer;text-align:center}
        .spawn-btn:hover{border-color:var(--accent);color:var(--accent)}

        /* â”€â”€ MAIN â”€â”€ */
        .main{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg)}
        .main-hdr{padding:10px 18px;border-bottom:1px solid var(--glass-b);display:flex;align-items:center;gap:10px;background:var(--bg1)}
        .main-title{font-size:14px;font-weight:500;flex:1}
        .main-acts{display:flex;gap:6px}
        .abtn{padding:7px 12px;border-radius:7px;background:var(--glass);border:1px solid var(--glass-b);color:var(--t2);font-size:11px;cursor:pointer;display:flex;align-items:center;gap:5px}
        .abtn:hover{background:rgba(255,255,255,.08);color:var(--t1)}.abtn.pri{background:var(--accent);color:#000;border-color:var(--accent)}

        /* â”€â”€ CHAT INPUT (bottom floating) â”€â”€ */
        .chat-input-wrap{position:absolute;bottom:0;left:0;right:0;padding:16px 18px;padding-bottom:calc(16px + env(safe-area-inset-bottom,0px));background:linear-gradient(transparent,var(--bg) 30%);pointer-events:none;z-index:10}
        .chat-input-row{display:flex;gap:10px;align-items:flex-end;pointer-events:auto;max-width:800px;margin:0 auto}
        .chat-targets{font-size:9px;color:var(--t3);margin-bottom:6px;pointer-events:auto;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
        .chat-targets .ct-tag{background:rgba(48,209,88,.12);color:var(--green);padding:2px 7px;border-radius:4px;font-weight:500}
        .chat-in{flex:1;background:rgba(10,10,10,.85);backdrop-filter:blur(40px);border:1px solid var(--glass-b);border-radius:14px;padding:14px 18px;color:var(--t1);font-size:14px;min-height:50px;max-height:150px;resize:none;font-family:inherit}
        .chat-in:focus{outline:none;border-color:rgba(255,255,255,.2);box-shadow:0 8px 32px rgba(0,0,0,.4)}
        .chat-in::placeholder{color:var(--t3)}
        .chat-send{width:50px;height:50px;border-radius:14px;background:var(--accent);border:none;color:#000;font-size:16px;font-weight:700;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
        .chat-send:disabled{opacity:.3;cursor:not-allowed}

        /* â”€â”€ EPHEMERAL RESPONSE â”€â”€ */
        .eph{position:absolute;bottom:90px;left:18px;right:18px;max-height:320px;overflow-y:auto;background:rgba(17,17,17,.95);backdrop-filter:blur(20px);border:1px solid var(--glass-b);border-radius:12px;padding:14px;font-size:12px;line-height:1.7;z-index:11;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none;display:none}
        .eph.active{display:block;opacity:1;transform:translateY(0);pointer-events:auto}
        .eph.fading{opacity:0;transform:translateY(10px)}
        .eph code{background:rgba(255,149,0,.15);padding:2px 5px;border-radius:4px;font-size:10px;font-family:'SF Mono',monospace}
        .eph pre{background:rgba(0,0,0,.4);padding:10px;border-radius:7px;overflow-x:auto;font-size:10px;margin:8px 0;font-family:'SF Mono',monospace}
        .eph-hdr{display:flex;align-items:center;gap:6px;margin-bottom:8px}
        .eph-pin{font-size:10px;cursor:pointer;padding:3px 7px;border-radius:4px;background:var(--glass);border:1px solid var(--glass-b);color:var(--t3);margin-left:auto}
        .eph-pin:hover{color:var(--t1);background:rgba(255,255,255,.1)}
        .eph-pin.pinned{color:var(--accent);border-color:var(--accent)}

        .panels{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:14px;padding:16px;overflow-y:auto}
        .pnl{background:var(--bg1);border:1px solid var(--glass-b);border-radius:12px;display:flex;flex-direction:column;min-height:280px;max-height:480px}
        .pnl.github{border-left:3px solid var(--c-github)}.pnl.agentcore{border-left:3px solid var(--c-agentcore)}
        .pnl.zenoh{border-left:3px solid var(--c-zenoh)}.pnl.local{border-left:3px solid var(--c-local)}
        .pnl.browser{border-left:3px solid var(--c-browser)}.pnl.virtual{border-left:3px solid var(--c-virtual)}
        .pnl.streaming{border-color:var(--green);box-shadow:0 0 20px rgba(48,209,88,.1)}
        .pnl-hdr{padding:12px 14px;border-bottom:1px solid var(--glass-b);display:flex;align-items:center;gap:8px}
        .pnl-icon{font-size:16px}.pnl-name{font-size:13px;font-weight:500;flex:1}.pnl-badges{display:flex;gap:5px;align-items:center}
        .pnl-acts{display:flex;gap:3px;margin-right:4px}
        .pnl-ab{width:22px;height:22px;border-radius:5px;background:0;border:1px solid var(--glass-b);color:var(--t3);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
        .pnl:hover .pnl-ab{opacity:1}
        .pnl-ab:hover{background:rgba(255,255,255,.1);color:var(--t1)}
        .pnl-ab.del:hover{background:rgba(255,69,58,.15);color:var(--red)}
        .pnl-body{flex:1;overflow-y:auto;padding:14px;font-size:12px;line-height:1.7}
        .pnl-body code{background:rgba(255,149,0,.15);padding:2px 5px;border-radius:4px;font-size:10px;font-family:'SF Mono',monospace}
        .pnl-body pre{background:rgba(0,0,0,.4);padding:10px;border-radius:7px;overflow-x:auto;font-size:10px;margin:8px 0;font-family:'SF Mono',monospace}
        .pnl-body ul,.pnl-body ol{padding-left:18px}.pnl-body p{margin-bottom:8px}.pnl-body a{color:var(--accent)}
        .pnl-ft{padding:10px 14px;border-top:1px solid var(--glass-b);display:flex;gap:8px}
        .pnl-in{flex:1;background:var(--glass);border:1px solid var(--glass-b);border-radius:8px;padding:10px 14px;color:var(--t1);font-size:12px}
        .pnl-in:focus{outline:none;border-color:var(--accent)}
        .pnl-send{padding:10px 16px;border-radius:8px;background:var(--accent);border:none;color:#000;font-size:12px;font-weight:600;cursor:pointer}
        .pnl-send:disabled{opacity:.3;cursor:not-allowed}
        .cursor::after{content:'â–‹';animation:blink 1s infinite;color:var(--accent)}@keyframes blink{50%{opacity:0}}
        .empty-pnl{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--t3);text-align:center}
        .empty-icon{font-size:44px;margin-bottom:14px}.empty-txt{font-size:11px;line-height:1.8}

        /* â”€â”€ RING PANEL â”€â”€ */
        .ring{width:260px;background:var(--bg1);border-left:1px solid var(--glass-b);display:flex;flex-direction:column;flex-shrink:0}
        .ring-hdr{padding:12px 14px;border-bottom:1px solid var(--glass-b);display:flex;align-items:center;gap:6px}
        .ring-title{font-size:11px;font-weight:500;flex:1;display:flex;align-items:center;gap:6px}
        .ring-clr{font-size:9px;color:var(--t3);cursor:pointer;padding:3px 6px;border-radius:4px}.ring-clr:hover{color:var(--red);background:rgba(255,100,100,.1)}
        .ring-body{flex:1;overflow-y:auto;padding:10px}
        .re{background:var(--glass);border-radius:7px;padding:9px 10px;margin-bottom:6px;font-size:10px}
        .re-hdr{display:flex;align-items:center;gap:5px;margin-bottom:4px}
        .re-agent{font-weight:600;flex:1}.re-time{color:var(--t3);font-size:8px}
        .re-txt{color:var(--t2);line-height:1.5}

        /* â”€â”€ MODAL â”€â”€ */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
        .modal.active{display:flex}
        .mbox{background:var(--bg1);border:1px solid var(--glass-b);border-radius:14px;max-width:520px;width:100%;max-height:80vh;overflow-y:auto}
        .mbox-hdr{padding:16px 18px;border-bottom:1px solid var(--glass-b);display:flex;align-items:center;gap:10px}
        .mbox-title{font-size:15px;font-weight:600;flex:1}
        .mbox-x{width:26px;height:26px;border-radius:6px;background:0;border:1px solid var(--glass-b);color:var(--t3);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
        .mbox-x:hover{background:var(--glass);color:var(--t1)}
        .mbox-body{padding:18px}
        .fg{margin-bottom:14px}.fl{display:block;font-size:9px;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);margin-bottom:5px;font-weight:600}
        .fi{width:100%;background:var(--glass);border:1px solid var(--glass-b);border-radius:7px;padding:10px 12px;color:var(--t1);font-size:12px;font-family:'SF Mono',monospace}
        .fi:focus{outline:none;border-color:var(--accent)}.fi::placeholder{color:var(--t3)}
        textarea.fi{min-height:70px;resize:vertical;font-family:inherit}
        .fhint{font-size:9px;color:var(--t3);margin-top:4px}
        .frow{display:flex;gap:10px}.frow .fg{flex:1}
        .btn-row{display:flex;gap:8px;margin-top:16px}
        .mbtn{flex:1;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--glass-b);background:var(--glass);color:var(--t2)}
        .mbtn:hover{background:rgba(255,255,255,.08);color:var(--t1)}.mbtn.pri{background:var(--accent);color:#000;border-color:var(--accent)}

        .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);padding:12px 22px;background:var(--bg1);border:1px solid var(--glass-b);border-radius:10px;font-size:12px;opacity:0;transition:all .3s;z-index:300;display:flex;align-items:center;gap:8px}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.ok{border-color:var(--green)}.toast.err{border-color:var(--red)}

        .connecting{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .3s}
        .connecting.hidden{opacity:0;pointer-events:none}.connecting-icon{font-size:56px;margin-bottom:20px;animation:bounce 1s infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .connecting-txt{font-size:15px;color:var(--t2);margin-bottom:6px}.connecting-sub{font-size:11px;color:var(--t3)}

        /* â”€â”€ VOICE â”€â”€ */
        .mic-btn{width:50px;height:50px;border-radius:14px;background:var(--glass);border:1px solid var(--glass-b);color:var(--t3);font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;pointer-events:auto}
        .mic-btn:hover{background:rgba(255,255,255,.1);color:var(--t1)}
        .mic-btn.active{background:var(--blue);color:#fff;border-color:var(--blue);animation:mic-pulse 1.5s infinite}
        .mic-btn.pending{background:var(--yellow);color:#000;border-color:var(--yellow);animation:pl 1s infinite}
        .mic-btn:disabled{opacity:.3;cursor:not-allowed}
        @keyframes mic-pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,122,255,.4)}50%{box-shadow:0 0 0 10px rgba(0,122,255,0)}}
        .voice-vis{height:28px;margin-bottom:8px;background:var(--glass);border-radius:8px;display:flex;align-items:center;justify-content:center;gap:2px;overflow:hidden;pointer-events:auto}
        .voice-vis .bar{width:3px;background:var(--blue);border-radius:2px;animation:vbar .6s ease-in-out infinite alternate}
        @keyframes vbar{from{height:4px}to{height:22px}}
        .voice-transcript{font-size:10px;padding:6px 10px;margin-bottom:6px;border-radius:6px;pointer-events:auto;max-width:800px;margin-left:auto;margin-right:auto}
        .voice-transcript.user{background:rgba(48,209,88,.1);border-left:2px solid var(--green)}
        .voice-transcript.assistant{background:rgba(0,122,255,.1);border-left:2px solid var(--blue)}
        .voice-cfg{display:flex;gap:6px;align-items:center;margin-bottom:6px;pointer-events:auto;max-width:800px;margin-left:auto;margin-right:auto}
        .voice-cfg select{background:var(--glass);border:1px solid var(--glass-b);border-radius:6px;padding:4px 8px;color:var(--t2);font-size:9px;font-family:inherit}
        .voice-cfg select:focus{outline:none;border-color:var(--accent)}

        @media(max-width:1200px){.ring{display:none}}
        @media(max-width:900px){.sb{width:250px}.panels{grid-template-columns:1fr}}
        @media(max-width:600px){.sb{display:none}}
    </style>
</head>
<body>
<div class="connecting" id="overlay">
    <div class="connecting-icon">ğŸ¦†</div>
    <div class="connecting-txt">Connecting to DevDuck Relay...</div>
    <div class="connecting-sub" id="overlaySub">ws://localhost:10000</div>
</div>

<div class="app">
<aside class="sb">
    <div class="sb-hdr">
        <div class="sb-icon">ğŸ•¸ï¸</div>
        <div style="flex:1"><div class="sb-title">mesh</div><div class="sb-sub"><span class="dot" id="statusDot"></span><span id="statusTxt">disconnected</span></div></div>
        <button class="sb-btn" onclick="openSettings()">âš™ï¸</button>
    </div>
    <div class="stats">
        <div class="st"><div class="st-v" id="cntLocal" style="color:var(--c-local)">0</div><div class="st-l">local</div></div>
        <div class="st"><div class="st-v" id="cntVirtual" style="color:var(--c-virtual)">0</div><div class="st-l">virtual</div></div>
        <div class="st"><div class="st-v" id="cntBrowser" style="color:var(--c-browser)">0</div><div class="st-l">browser</div></div>
        <div class="st"><div class="st-v" id="cntGithub" style="color:var(--c-github)">0</div><div class="st-l">github</div></div>
        <div class="st"><div class="st-v" id="cntCloud" style="color:var(--c-agentcore)">0</div><div class="st-l">cloud</div></div>
        <div class="st"><div class="st-v" id="cntZenoh" style="color:var(--c-zenoh)">0</div><div class="st-l">zenoh</div></div>
    </div>
    <div class="sb-scroll" id="agentsList"></div>
    <div class="sb-spawn">
        <button class="spawn-btn" onclick="openSpawn('virtual')">+ virtual</button>
        <button class="spawn-btn" onclick="openSpawn('browser')">+ browser</button>
    </div>
</aside>

<main class="main">
    <header class="main-hdr">
        <div class="main-title" id="mainTitle">agents</div>
        <div class="main-acts">
            <button class="abtn" onclick="refresh()">ğŸ”„</button>
            <button class="abtn" onclick="broadcastAll()">ğŸ“¢ Broadcast</button>
            <button class="abtn" onclick="clearAll()">ğŸ—‘ï¸</button>
        </div>
    </header>
    <div style="flex:1;position:relative;display:flex;flex-direction:column;min-height:0">
    <div class="panels" id="panels" style="flex:1;padding-bottom:100px"></div>
    <!-- Ephemeral response bubble -->
    <div class="eph" id="ephResponse"></div>
    <!-- Floating chat input -->
    <div class="chat-input-wrap">
        <div class="chat-targets" id="chatTargets"></div>
        <!-- Voice config bar (visible when voice active or configuring) -->
        <div class="voice-cfg" id="voiceCfg" style="display:none">
            <span style="font-size:9px;color:var(--t3)">ğŸ¤ Provider:</span>
            <select id="voiceProvider" onchange="voiceCfgChanged()">
                <option value="novasonic">Nova Sonic (AWS)</option>
                <option value="gemini_live">Gemini Live</option>
                <option value="openai">OpenAI Realtime</option>
            </select>
            <select id="voiceSelect" onchange="voiceCfgChanged()"></select>
        </div>
        <!-- Voice transcript -->
        <div id="voiceTranscript" style="display:none"></div>
        <!-- Voice visualizer -->
        <div class="voice-vis" id="voiceVis" style="display:none"></div>
        <div class="chat-input-row">
            <button class="mic-btn" id="micBtn" onclick="toggleVoice()" title="Start/Stop Voice">ğŸ¤</button>
            <textarea class="chat-in" id="chatInput" placeholder="Message selected agents..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();chatSend()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,150)+'px'"></textarea>
            <button class="chat-send" id="chatSendBtn" onclick="chatSend()">â†’</button>
        </div>
    </div>
    </div>
</main>

<aside class="ring">
    <div class="ring-hdr">
        <div class="ring-title"><span class="dot on"></span> Ring Context</div>
        <span class="ring-clr" onclick="clearRing()">clear</span>
    </div>
    <div class="ring-body" id="ringBody"><div class="empty-pnl"><div style="font-size:9px;color:var(--t3)">Activity appears here</div></div></div>
</aside>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
<div class="mbox">
    <div class="mbox-hdr"><span>âš™ï¸</span><span class="mbox-title">Settings</span><button class="mbox-x" onclick="closeModal('settingsModal')">Ã—</button></div>
    <div class="mbox-body">
        <div class="fg"><label class="fl">Local DevDuck WS Port</label><input class="fi" id="sLocalPort" value="10001" placeholder="10001"><div class="fhint">Direct WS to local DevDuck</div></div>
        <div class="fg"><label class="fl">GitHub PAT</label><input type="password" class="fi" id="sToken" placeholder="ghp_..."><div class="fhint">For GitHub agent discovery</div></div>
        <div class="fg"><label class="fl">GitHub Repos (comma-separated)</label><input class="fi" id="sRepos" placeholder="owner/repo,owner2/repo2"></div>
        <div class="frow">
            <div class="fg"><label class="fl">AWS Region</label><input class="fi" id="sRegion" value="us-west-2"></div>
            <div class="fg"><label class="fl">Relay Port</label><input class="fi" id="sRelayPort" value="10000"></div>
        </div>
        <div class="fg"><label class="fl">Anthropic API Key (for browser agents)</label><input type="password" class="fi" id="sAnthropicKey" placeholder="sk-ant-..."></div>
        <div class="fg"><label class="fl">OpenAI API Key (for browser agents)</label><input type="password" class="fi" id="sOpenaiKey" placeholder="sk-..."></div>
        <div class="fg"><label class="fl">Bedrock Bearer Token (for browser agents)</label><input type="password" class="fi" id="sBedrockKey" placeholder="Bearer token"><div class="fhint">From Bedrock API Keys console</div></div>
        <div class="fg"><label class="fl">Bedrock Region</label><input class="fi" id="sBedrockRegion" value="us-east-1" placeholder="us-east-1"><div class="fhint">For Bedrock browser agents</div></div>
        <div class="fg"><label class="fl">Gemini API Key (for voice)</label><input type="password" class="fi" id="sGeminiKey" placeholder="AIza..."><div class="fhint">For Gemini Live voice provider</div></div>
        <div class="btn-row"><button class="mbtn" onclick="closeModal('settingsModal')">Cancel</button><button class="mbtn pri" onclick="saveSettings()">Save & Reconnect</button></div>
    </div>
</div>
</div>

<!-- SPAWN MODAL -->
<div class="modal" id="spawnModal">
<div class="mbox">
    <div class="mbox-hdr"><span id="spawnIcon">ğŸ¤–</span><span class="mbox-title" id="spawnTitle">New Agent</span><button class="mbox-x" onclick="closeModal('spawnModal')">Ã—</button></div>
    <div class="mbox-body">
        <input type="hidden" id="spawnType" value="virtual">
        <div class="frow">
            <div class="fg"><label class="fl">Agent Name</label><input class="fi" id="spawnName" placeholder="e.g. researcher, coder"></div>
            <div class="fg"><label class="fl">Color</label><input type="color" class="fi" id="spawnColor" value="#ff375f" style="height:38px;padding:3px"></div>
        </div>
        <!-- Virtual agent options -->
        <div id="virtualOpts">
            <div class="fg"><label class="fl">System Prompt</label><textarea class="fi" id="spawnPrompt" rows="3" placeholder="You are a helpful assistant..."></textarea></div>
            <div class="frow">
                <div class="fg"><label class="fl">Tools (optional)</label><input class="fi" id="spawnTools" placeholder="strands_tools:shell,editor"><div class="fhint">Leave empty for default DevDuck tools</div></div>
                <div class="fg"><label class="fl">Model (optional)</label><input class="fi" id="spawnModel" placeholder="default"><div class="fhint">Override model on backend</div></div>
            </div>
        </div>
        <!-- Browser agent options -->
        <div id="browserOpts" style="display:none">
            <div class="fg"><label class="fl">Provider</label><select class="fi" id="spawnProvider"><option value="anthropic">Anthropic</option><option value="openai">OpenAI</option><option value="bedrock">Amazon Bedrock</option></select></div>
            <div class="fg"><label class="fl">Model ID (optional)</label><input class="fi" id="spawnModelId" placeholder="Leave empty for default"><div class="fhint" id="spawnModelHint">Default: claude-sonnet-4-20250514</div></div>
            <div class="fg"><label class="fl">System Prompt</label><textarea class="fi" id="spawnBrowserPrompt" rows="3" placeholder="You are a helpful assistant..."></textarea></div>
        </div>
        <div class="btn-row"><button class="mbtn" onclick="closeModal('spawnModal')">Cancel</button><button class="mbtn pri" onclick="spawnAgent()">Create Agent</button></div>
    </div>
</div>
</div>

<!-- EDIT AGENT MODAL -->
<div class="modal" id="editModal">
<div class="mbox">
    <div class="mbox-hdr"><span>âœï¸</span><span class="mbox-title">Edit Agent: <span id="editTitle"></span></span><button class="mbox-x" onclick="closeModal('editModal')">Ã—</button></div>
    <div class="mbox-body">
        <input type="hidden" id="editId">
        <div class="frow">
            <div class="fg"><label class="fl">Agent Name</label><input class="fi" id="editName"></div>
            <div class="fg"><label class="fl">Color</label><input type="color" class="fi" id="editColor" style="height:38px;padding:3px"></div>
        </div>
        <div class="fg"><label class="fl">System Prompt</label><textarea class="fi" id="editPrompt" rows="4"></textarea></div>
        <div class="frow">
            <div class="fg"><label class="fl">Tools (optional)</label><input class="fi" id="editTools" placeholder="strands_tools:shell,editor"></div>
            <div class="fg"><label class="fl">Model (optional)</label><input class="fi" id="editModel" placeholder="default"></div>
        </div>
        <div class="fg" id="editProviderWrap" style="display:none">
            <label class="fl">Provider</label>
            <select class="fi" id="editProvider"><option value="anthropic">Anthropic</option><option value="openai">OpenAI</option><option value="bedrock">Amazon Bedrock</option></select>
        </div>
        <div class="fg" id="editModelIdWrap" style="display:none">
            <label class="fl">Model ID</label><input class="fi" id="editModelId" placeholder="Leave empty for default">
        </div>
        <div class="btn-row">
            <button class="mbtn" onclick="closeModal('editModal')">Cancel</button>
            <button class="mbtn" style="color:var(--red);border-color:rgba(255,69,58,.3)" onclick="deleteAgent()">ğŸ—‘ï¸ Delete</button>
            <button class="mbtn pri" onclick="saveEdit()">ğŸ’¾ Save</button>
        </div>
    </div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Polyfills
if(typeof Symbol.dispose==='undefined')Symbol.dispose=Symbol('Symbol.dispose');
if(typeof Symbol.asyncDispose==='undefined')Symbol.asyncDispose=Symbol('Symbol.asyncDispose');
</script>

<!-- Strands SDK for browser agents -->
<script type="module">
import { Agent, tool, Model, TextBlock, Message, z, AnthropicModel, OpenAIModel, BedrockModel } from './strands.js';
window._StrandsAgent=Agent;window._StrandsTool=tool;window._StrandsModel=Model;
window._StrandsTextBlock=TextBlock;window._StrandsMessage=Message;window._StrandsZ=z;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROWSER MODEL PROVIDERS â€” imported from strands.js SDK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window._BrowserModels={AnthropicBrowserModel:AnthropicModel,OpenAIBrowserModel:OpenAIModel,BedrockBrowserModel:BedrockModel};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROWSER TOOLS for browser agents
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const renderUiTool=tool({name:'render_ui',description:'Render HTML/CSS/JS in the chat panel.',inputSchema:z.object({html:z.string(),css:z.string().optional(),script:z.string().optional(),title:z.string().optional()}),callback:async(input)=>{return{rendered:true,title:input.title||'component'}}});
const jsEvalTool=tool({name:'javascript_eval',description:'Execute JavaScript and return result.',inputSchema:z.object({code:z.string()}),callback:async(input)=>{try{return{result:String(eval(input.code))}}catch(e){return{error:e.message}}}});
const storageGetTool=tool({name:'storage_get',description:'Read from localStorage.',inputSchema:z.object({key:z.string()}),callback:async(input)=>({key:input.key,value:localStorage.getItem(input.key)})});
const storageSetTool=tool({name:'storage_set',description:'Write to localStorage.',inputSchema:z.object({key:z.string(),value:z.string()}),callback:async(input)=>{localStorage.setItem(input.key,input.value);return{success:true}}});
const fetchUrlTool=tool({name:'fetch_url',description:'HTTP fetch (CORS applies).',inputSchema:z.object({url:z.string(),method:z.string().optional(),headers:z.record(z.string(),z.string()).optional(),body:z.string().optional()}),callback:async(input)=>{try{const r=await fetch(input.url,{method:input.method||'GET',headers:input.headers||{},body:input.body});const ct=r.headers.get('content-type');return{status:r.status,data:ct?.includes('json')?await r.json():await r.text()}}catch(e){return{error:e.message}}}});

window._BrowserTools=[renderUiTool,jsEvalTool,storageGetTool,storageSetTool,fetchUrlTool];

console.log('âœ… Strands SDK loaded for browser agents');
</script>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE='devduck_one_v2';
const ICONS={github:'ğŸ™',agentcore:'â˜ï¸',zenoh:'ğŸ”—',local:'ğŸ’»',browser:'ğŸ§ ',virtual:'ğŸ¤–'};
const DEFAULT_MODELS={anthropic:'claude-sonnet-4-20250514',openai:'gpt-4o',bedrock:'us.anthropic.claude-sonnet-4-20250514-v1:0'};

const S={
    relay:null, relayOk:false,
    localWs:null, localOk:false,
    agents:new Map(),
    ring:[],
    cfg:{
        localPort:10001, relayPort:10000,
        token:'', repos:['cagataycali/strands-coder'], region:'us-west-2',
        anthropicKey:'', openaiKey:'', bedrockKey:'', bedrockRegion:'us-east-1', geminiKey:'',
        voiceProvider:'novasonic', voiceVoice:'tiffany',
        virtualAgents:[], // {id,name,color,systemPrompt,tools,model}
        browserAgents:[], // {id,name,color,provider,modelId,systemPrompt}
    },
    activePanel:null,
    reconnectTimer:null,
    selectedAgents:new Set(), // multi-select for fan-out
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadCfg(){
    try{const s=localStorage.getItem(STORAGE);if(s)Object.assign(S.cfg,JSON.parse(s))}catch(e){}
    // ğŸ”‘ Sync with AgentMesh unified credentials
    if(window.AgentMesh?.getCredentials){
        const meshCreds=window.AgentMesh.getCredentials();
        if(meshCreds.anthropic?.apiKey&&!S.cfg.anthropicKey)S.cfg.anthropicKey=meshCreds.anthropic.apiKey;
        if(meshCreds.openai?.apiKey&&!S.cfg.openaiKey)S.cfg.openaiKey=meshCreds.openai.apiKey;
        if(meshCreds.bedrock?.apiKey&&!S.cfg.bedrockKey)S.cfg.bedrockKey=meshCreds.bedrock.apiKey;
        if(meshCreds.bedrock?.region&&!S.cfg.bedrockRegion)S.cfg.bedrockRegion=meshCreds.bedrock.region;
    }
}
function saveCfg(){try{localStorage.setItem(STORAGE,JSON.stringify(S.cfg))}catch(e){}}

window.openSettings=()=>{
    E('sLocalPort').value=S.cfg.localPort;E('sToken').value=S.cfg.token||'';
    E('sRepos').value=(S.cfg.repos||[]).join(',');E('sRegion').value=S.cfg.region;
    E('sRelayPort').value=S.cfg.relayPort;
    E('sAnthropicKey').value=S.cfg.anthropicKey||'';E('sOpenaiKey').value=S.cfg.openaiKey||'';E('sBedrockKey').value=S.cfg.bedrockKey||'';E('sBedrockRegion').value=S.cfg.bedrockRegion||'us-east-1';E('sGeminiKey').value=S.cfg.geminiKey||'';
    E('settingsModal').classList.add('active');
};
window.saveSettings=()=>{
    S.cfg.localPort=parseInt(E('sLocalPort').value)||10001;
    S.cfg.token=E('sToken').value.trim();
    S.cfg.repos=E('sRepos').value.split(',').map(r=>r.trim()).filter(Boolean);
    S.cfg.region=E('sRegion').value.trim()||'us-west-2';
    S.cfg.relayPort=parseInt(E('sRelayPort').value)||10000;
    S.cfg.anthropicKey=E('sAnthropicKey').value.trim();
    S.cfg.openaiKey=E('sOpenaiKey').value.trim();
    S.cfg.bedrockKey=E('sBedrockKey').value.trim();
    S.cfg.bedrockRegion=E('sBedrockRegion').value.trim()||'us-east-1';
    S.cfg.geminiKey=E('sGeminiKey').value.trim();
    saveCfg();
    // ğŸ”‘ Sync to AgentMesh unified credentials
    if(window.AgentMesh?.setCredentials){
        window.AgentMesh.setCredentials({
            anthropic:{apiKey:S.cfg.anthropicKey,model:'anthropic.claude-opus-4-6-v1'},
            openai:{apiKey:S.cfg.openaiKey,model:'gpt-5.2-2025-12-11'},
            bedrock:{apiKey:S.cfg.bedrockKey,region:S.cfg.bedrockRegion,model:'global.anthropic.claude-opus-4-6-v1'}
        });
    }
    closeModal('settingsModal');
    _browserAgentInstances.clear(); // Re-create agents with new API keys
    if(S.relay)S.relay.close();if(S.localWs)S.localWs.close();
    connectRelay();connectLocal();toast('Settings saved','ok');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWN AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openSpawn=(type)=>{
    E('spawnType').value=type;
    E('spawnTitle').textContent=type==='virtual'?'New Virtual Agent':'New Browser Agent';
    E('spawnIcon').textContent=type==='virtual'?'ğŸ¤–':'ğŸ§ ';
    E('virtualOpts').style.display=type==='virtual'?'block':'none';
    E('browserOpts').style.display=type==='browser'?'block':'none';
    E('spawnName').value='';E('spawnColor').value=type==='virtual'?'#ff375f':'#007aff';
    E('spawnModal').classList.add('active');
};

window.spawnAgent=()=>{
    const type=E('spawnType').value;
    const name=E('spawnName').value.trim();if(!name){toast('Enter a name','err');return;}
    const color=E('spawnColor').value;
    const id=type+':'+name;

    if(S.agents.has(id)){toast('Agent exists','err');return;}

    if(type==='virtual'){
        const cfg={id,name,color,type:'virtual',
            systemPrompt:E('spawnPrompt').value.trim()||`You are ${name}, a helpful AI assistant.`,
            tools:E('spawnTools').value.trim()||null,
            model:E('spawnModel').value.trim()||null};
        S.cfg.virtualAgents.push(cfg);saveCfg();
        registerAgent({id,type:'virtual',name,color,status:'ready',
            description:cfg.systemPrompt.slice(0,60)+'...',config:cfg});
    } else {
        const provider=E('spawnProvider').value;
        const modelId=E('spawnModelId').value.trim()||null;
        const sp=E('spawnBrowserPrompt').value.trim()||`You are ${name}, a helpful AI assistant.`;
        const cfg={id,name,color,type:'browser',provider,modelId,systemPrompt:sp};
        S.cfg.browserAgents.push(cfg);saveCfg();
        registerAgent({id,type:'browser',name,color,status:'ready',
            description:`${provider} ${modelId||DEFAULT_MODELS[provider]||''}`,config:cfg});
    }
    closeModal('spawnModal');updateUI();toast(`Agent "${name}" created`,'ok');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELAY CONNECTION (port 10000)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectRelay(){
    const port=S.cfg.relayPort||10000;
    E('overlay').classList.remove('hidden');E('overlaySub').textContent=`ws://localhost:${port}`;
    const ws=new WebSocket(`ws://localhost:${port}`);
    const timeout=setTimeout(()=>{ws.close();relayFailed()},4000);
    ws.onopen=()=>{
        clearTimeout(timeout);S.relay=ws;S.relayOk=true;
        E('overlay').classList.add('hidden');updateStatus();toast('Relay connected','ok');
        ws.send(JSON.stringify({type:'configure',github_token:S.cfg.token,github_repos:S.cfg.repos,region:S.cfg.region}));
        ws.send(JSON.stringify({type:'list_agents'}));ws.send(JSON.stringify({type:'get_ring',max_entries:50}));
        // Explicitly fetch GitHub agents after configure
        if(S.cfg.token&&S.cfg.repos?.length){ws.send(JSON.stringify({type:'list_github',token:S.cfg.token,repos:S.cfg.repos}))}
    };
    ws.onmessage=e=>handleRelayMsg(JSON.parse(e.data));
    ws.onerror=()=>clearTimeout(timeout);
    ws.onclose=()=>{S.relayOk=false;updateStatus();clearTimeout(S.reconnectTimer);S.reconnectTimer=setTimeout(connectRelay,5000)};
}
function relayFailed(){E('overlaySub').textContent='Relay not found â€” start agentcore_proxy';setTimeout(()=>E('overlay').classList.add('hidden'),2000);S.reconnectTimer=setTimeout(connectRelay,5000);updateUI();}

function handleRelayMsg(msg){
    console.log('ğŸ“¨ Relay msg:', msg.type, msg);
    switch(msg.type){
        case'connected':
            if(msg.agents)msg.agents.forEach(a=>{if(a.type==='zenoh'&&!a.description)a.description=`${a.hostname||'?'} (${a.model||'?'})`;registerAgent(a)});
            if(msg.ring_context){S.ring=msg.ring_context;renderRing()}
            // Register this browser as a mesh peer so CLI/zenoh can invoke us
            if(msg.ws_id){
                S.myWsId=msg.ws_id;
                const meshAgent=getMeshAgent();
                S.relay.send(JSON.stringify({
                    type:'register_browser_peer',
                    name:meshAgent?meshAgent.name:'browser-mesh',
                    model:meshAgent?`${meshAgent.config?.provider||'browser'} ${meshAgent.config?.modelId||'agent'}`:'browser-agent',
                    tools:['render_ui','javascript_eval','fetch_url','storage_get','storage_set'],
                    tool_count:5,
                    system_prompt:meshAgent?.config?.systemPrompt?.slice(0,100)||'Browser mesh agent',
                }));
            }
            break;
        case'agents_list':
            console.log('ğŸ“‹ agents_list received:', msg.agents?.length, 'agents, types:', msg.agents?.map(a=>a.type));
            // Clear only remote-discovered agents (preserve local, virtual, user-created browser, AND github with active state)
            for(const[id,a]of S.agents){
                if(['local','virtual'].includes(a.type))continue;
                if(a.type==='browser'&&(a.config||a._isMeshAgent))continue;
                if(a.type==='github'&&(a.streaming||a.githubLogs))continue; // preserve active github agents
                S.agents.delete(id);
            }
            (msg.agents||[]).forEach(a=>registerAgent(a));break;
        case'github_list':case'agentcore_list':case'zenoh_list':
            (msg.agents||msg.peers||[]).forEach(a=>registerAgent(a));break;
        case'zenoh_peers_update':
            console.log('ğŸ”— zenoh_peers_update received:', msg.peers?.length, 'peers', msg.peers?.map(p=>`${p.id}(${p.type})`));
            // Registry-based: peers now include ALL types (zenoh, browser, agentcore, etc.)
            // Only clear zenoh + registry browser â€” PRESERVE github, agentcore, local, virtual, user-created browser
            for(const[id,a]of S.agents){
                if(a.type==='zenoh')S.agents.delete(id);
                if(a.type==='browser'&&id.startsWith('browser:')&&!a.config&&!a._isMeshAgent)S.agents.delete(id);
                // DO NOT delete github or agentcore agents here
            }
            (msg.peers||[]).forEach(p=>{
                const type=p.type||'zenoh';
                // Skip re-registering user-created browser agents
                if(type==='browser'&&S.agents.has(p.id)&&S.agents.get(p.id).config)return;
                registerAgent({
                    id:p.id,type,name:p.name||p.hostname||p.id,
                    hostname:p.hostname,model:p.model,status:p.status||'active',
                    is_self:!!p.is_self,tools:p.tools||[],tool_count:p.tool_count||0,
                    system_prompt:p.system_prompt||'',
                    cwd:p.cwd||'',pplatform:p.platform||'',
                    description:p.description||`${p.hostname||''} (${p.model||''})`+(p.is_self?' [self]':''),
                })
            });break;
        case'turn_start':handleStreamStart(msg);break;
        case'chunk':handleChunk(msg);break;
        case'tool_start':case'tool_end':handleToolEvt(msg);break;
        case'turn_end':handleStreamEnd(msg);break;
        case'github_triggered':
            if(msg.status==='success'){toast('GitHub workflow triggered!','ok');addRing('github','github',`Triggered: ${msg.message||msg.url||msg.repo}`);
                // If we have a running poll, it'll auto-start from the proxy
            }
            else toast(`GitHub error: ${msg.error}`,'err');break;
        case'github_status':handleGHStatus(msg);break;
        case'github_logs':handleGHLogs(msg);break;
        case'ring_context':S.ring=msg.entries||[];renderRing();break;
        case'ring_update':{const e=msg.entry;if(e&&!S.ring.some(r=>r.id===e.id)){S.ring.push(e);if(S.ring.length>100)S.ring=S.ring.slice(-100);renderRing()}}break;
        case'configured':case'pong':case'browser_peer_registered':case'browser_peer_updated':case'ring_added':break;
        case'browser_peers_update':
            // Update browser peers in agent list
            for(const[id,a]of S.agents)if(a.type==='browser'&&id.startsWith('browser:')&&!a.config)S.agents.delete(id);
            (msg.peers||[]).forEach(p=>registerAgent({
                id:p.id,type:'browser',name:p.name||p.id,
                model:p.model,status:'active',
                tools:p.tools||[],tool_count:p.tool_count||0,
                system_prompt:p.system_prompt||'',
                description:`${p.model||'browser agent'}`,
                ws_id:p.ws_id,
            }));break;
        case'browser_invoke':
            // Incoming invoke from CLI/zenoh â€” run our mesh agent
            handleBrowserInvoke(msg);break;
        case'error':toast(`Error: ${msg.error}`,'err');break;
    }
    updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL DEVDUCK CONNECTION (direct WS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectLocal(){
    const port=S.cfg.localPort||10001;
    const ws=new WebSocket(`ws://localhost:${port}`);
    ws.onopen=()=>{
        S.localWs=ws;S.localOk=true;
        registerAgent({id:'local:devduck',type:'local',name:'ğŸ¦† Local DevDuck',status:'ready',description:`ws://localhost:${port}`});
        updateStatus();updateUI();
    };
    ws.onmessage=e=>{try{handleLocalMsg(JSON.parse(e.data))}catch(err){}};
    ws.onerror=()=>{};
    ws.onclose=()=>{S.localOk=false;S.localWs=null;const a=S.agents.get('local:devduck');if(a)a.status='offline';updateStatus();updateUI();setTimeout(connectLocal,5000)};
}

function handleLocalMsg(msg){
    const a=S.agents.get('local:devduck');if(!a)return;
    if(msg.type==='connected')return;
    if(msg.type==='turn_start'){a.streaming=true;a.streamText='';a.streamTools=[];a.status='streaming';schedRender('local:devduck')}
    else if(msg.type==='chunk'){if(!a.streaming){a.streaming=true;a.streamText='';a.status='streaming'}a.streamText=(a.streamText||'')+( msg.data||'');schedRender('local:devduck')}
    else if(msg.type==='tool_start'){if(!a.streamTools)a.streamTools=[];a.streamTools.push({name:msg.data||'',id:msg.tool_id,status:'running'});schedRender('local:devduck')}
    else if(msg.type==='tool_end'){const tc=(a.streamTools||[]).find(t=>t.id===msg.tool_id);if(tc)tc.status='done';schedRender('local:devduck')}
    else if(msg.type==='turn_end'){const ft=(a.streamText||'').trim();if(ft)a.messages.push({role:'assistant',content:ft});a.streaming=false;a.streamTools=[];a.status='ready';addRing('local:devduck','local',ft.slice(0,150));updatePanel('local:devduck');updateUI()}
    else if(msg.type==='error'){a.messages.push({role:'assistant',content:`âŒ ${msg.data||msg.error||'unknown error'}`});a.streaming=false;a.status='ready';updatePanel('local:devduck');updateUI()}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registerAgent(d){if(!d.id)return;const ex=S.agents.get(d.id)||{};S.agents.set(d.id,{...ex,...d,messages:ex.messages||[],streaming:ex.streaming||false,streamText:ex.streamText||''})}

const _rt={};
function schedRender(id){if(_rt[id])return;_rt[id]=setTimeout(()=>{delete _rt[id];updatePanel(id)},80)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STREAMING HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleStreamStart(m){const id=m.agent_id;if(!id)return;if(!S.agents.has(id))registerAgent({id,type:m.agent_type||'agentcore',name:m.agent_id,status:'streaming'});const a=S.agents.get(id);a.streaming=true;a.streamText='';a.streamTools=[];a.status='streaming';if(m.agent_type)a.type=m.agent_type;updateUI()}
function handleChunk(m){const id=m.agent_id;if(!id)return;const a=S.agents.get(id);if(!a)return;if(!a.streaming){a.streaming=true;a.streamText=a.streamText||'';a.status='streaming'}a.streamText=(a.streamText||'')+(m.data||'');schedRender(id)}
function handleToolEvt(m){const id=m.agent_id;if(!id)return;const a=S.agents.get(id);if(!a)return;if(!a.streamTools)a.streamTools=[];if(m.type==='tool_start')a.streamTools.push({name:m.tool_name||m.data,id:m.tool_id,status:'running'});else{const tc=a.streamTools.find(t=>t.id===m.tool_id);if(tc)tc.status='done'}schedRender(id)}
function handleStreamEnd(m){const id=m.agent_id;if(!id)return;const a=S.agents.get(id);if(!a)return;if(_rt[id]){clearTimeout(_rt[id]);delete _rt[id]}
    // Skip if this is a GitHub agent that already completed via handleGHStatus (prevents duplicate messages)
    if(a.type==='github'&&a._ghCompleted){a._ghCompleted=false;return}
    const isGHL=a.type==='github'&&a.githubLogs;const ft=isGHL?'':((a.streamText||'').trim()||m.response||'');if(ft)a.messages.push({role:'assistant',content:ft});a.streaming=false;a.streamTools=[];a.status='ready';if(m.agent_type)a.type=m.agent_type;if(ft)addRing(id,a.type,ft.slice(0,150));updatePanel(id);updateUI()}

function handleGHStatus(m){const id=m.agent_id;if(!id)return;const a=S.agents.get(id);if(!a)return;const sm={queued:'queued',in_progress:'running',completed:'ready',polling:'running',not_found:'failed'};a.status=sm[m.status]||m.status;a.run_url=m.url;a.run_id=m.run_id;a.conclusion=m.conclusion;
    if(m.status==='completed'){
        // FIRST: save accumulated logs as a message before clearing
        if(a.githubLogs){const lines=a.githubLogs.split('\n');const tail=lines.slice(-100).join('\n');a.messages.push({role:'assistant',content:'```\n'+tail+'\n```'})}
        const ic=m.conclusion==='success'?'âœ…':m.conclusion==='failure'?'âŒ':'âš ï¸';
        a.messages.push({role:'assistant',content:`${ic} Run **${m.conclusion}**\n[View run](${m.url})`});
        a.streaming=false;a.streamText='';a.githubLogs='';a._ghCompleted=true;
        addRing(id,'github',`Run ${m.conclusion}: ${m.repo||id}`)}
    else if(m.status==='polling'){a.messages.push({role:'assistant',content:`â³ Tracking run [${m.run_id}](${m.url})...`});a.streaming=true;a.streamText='';a.githubLogs='';a._ghCompleted=false;addRing(id,'github',`Polling run ${m.run_id}`)}
    else if(m.status==='in_progress'&&!a.streaming){a.streaming=true;addRing(id,'github',`Run in progress...`)}
    else if(m.status==='not_found'){a.messages.push({role:'assistant',content:'âŒ Could not find workflow run'});a.streaming=false}
    updatePanel(id);updateUI()}
function handleGHLogs(m){const id=m.agent_id;if(!id)return;const a=S.agents.get(id);if(!a)return;if(!a.githubLogs)a.githubLogs='';a.githubLogs+=m.log_chunk||'';a.streaming=true;
    // Parse and show last N lines as streaming text with syntax highlighting
    const lines=a.githubLogs.split('\n');const tailLines=lines.slice(-80).join('\n');a.streamText='```\n'+tailLines+'\n```';
    // Inject notable log lines into ring (errors, completions, agent output)
    const newLines=(m.log_chunk||'').split('\n');
    for(const line of newLines){const l=line.trim();if(!l)continue;
        if(l.includes('error')||l.includes('ERROR')||l.includes('âŒ')){addRing(id,'github',`âš ï¸ ${l.slice(0,120)}`)}
        else if(l.includes('Agent output:')||l.includes('Result:')){addRing(id,'github',`ğŸ“‹ ${l.slice(0,120)}`)}
    }
    schedRender(id)}

// Poll GitHub logs for a specific agent (e.g. to watch a recently triggered run)
window.pollGHLogs=function(agentId){
    if(!S.relay||!S.relayOk){toast('Relay not connected','err');return}
    const a=S.agents.get(agentId);if(!a||a.type!=='github')return;
    const parts=agentId.split(':');
    if(parts.length<3)return;
    S.relay.send(JSON.stringify({type:'poll_github_logs',repo:parts[1],workflow:parts[2]||'agent.yml',token:S.cfg.token,agent_id:agentId,run_id:a.run_id||null}));
    toast('Polling GitHub logs...');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.sendMsg=function(agentId){
    const sid=safeId(agentId);const input=E(`in-${sid}`);const txt=input?.value?.trim();if(!txt)return;input.value='';
    const a=S.agents.get(agentId);if(!a)return;a.messages.push({role:'user',content:txt});
    // Push user query to ring so CLI sees what browser is asking
    addRing('browser:user',a.type||'browser',`â†’ ${agentId}: ${txt.slice(0,120)}`);

    if(agentId==='local:devduck'){
        if(S.localWs&&S.localWs.readyState===1)S.localWs.send(txt);
        else a.messages.push({role:'assistant',content:'âŒ Local DevDuck not connected'});
    } else if(a.type==='virtual'){
        // Virtual agent â†’ send via local DevDuck WS with system_prompt + tools override
        if(S.localWs&&S.localWs.readyState===1){
            const payload={type:'message',text:txt,turn_id:crypto.randomUUID().slice(0,8),timestamp:Date.now()};
            if(a.config?.systemPrompt)payload.system_prompt=a.config.systemPrompt;
            // For virtual agents, we route through relay if available, or local WS
            if(S.relay&&S.relayOk){
                // Use relay invoke with agentcore type if the virtual agent has cloud backend
                // Otherwise route through local DevDuck WS
                S.localWs.send(JSON.stringify(payload));
                a.streaming=true;a.streamText='';a.status='streaming';
                // Track turn_id to map responses
                a._turnId=payload.turn_id;
            } else {
                S.localWs.send(JSON.stringify(payload));
                a.streaming=true;a.streamText='';a.status='streaming';
                a._turnId=payload.turn_id;
            }
        } else a.messages.push({role:'assistant',content:'âŒ Not connected to DevDuck'});
    } else if(a.type==='browser'){
        // Browser agent â†’ run in-browser using Strands SDK
        runBrowserAgent(a,txt);
    } else if(a.type==='github'){
        const parts=agentId.split(':');
        S.relay?.send(JSON.stringify({type:'trigger_github',repo:parts[1],workflow:parts[2]||'agent.yml',prompt:txt,token:S.cfg.token}));
    } else {
        const turnId=crypto.randomUUID();
        S.relay?.send(JSON.stringify({type:'invoke',agent_id:agentId,agent_type:a.type,prompt:txt,turn_id:turnId,
            system_prompt:a.config?.systemPrompt||undefined,tools:a.config?.tools||undefined,model:a.config?.model||undefined}));
    }
    updateUI();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROWSER AGENT EXECUTION (Strands SDK in-browser)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _browserAgentInstances=new Map(); // agentId â†’ {agent, model}

async function runBrowserAgent(a,txt){
    if(!window._StrandsAgent||!window._BrowserModels){a.messages.push({role:'assistant',content:'âŒ Strands SDK not loaded yet. Refresh page.'});updateUI();return}
    const cfg=a.config||{};const provider=cfg.provider||'anthropic';
    // Resolve API key from settings
    let apiKey='';
    if(provider==='anthropic')apiKey=S.cfg.anthropicKey;
    else if(provider==='openai')apiKey=S.cfg.openaiKey;
    else if(provider==='bedrock')apiKey=S.cfg.bedrockKey;
    if(!apiKey){a.messages.push({role:'assistant',content:`âŒ No ${provider} API key configured. Open Settings to add it.`});updateUI();return}
    // Create or reuse agent instance
    let inst=_browserAgentInstances.get(a.id);
    const modelId=cfg.modelId||null;
    if(!inst){
        let model;
        const Models=window._BrowserModels;
        if(provider==='anthropic')model=new Models.AnthropicBrowserModel({apiKey,modelId:modelId||'claude-sonnet-4-20250514'});
        else if(provider==='openai')model=new Models.OpenAIBrowserModel({apiKey,modelId:modelId||'gpt-4o'});
        else if(provider==='bedrock')model=new Models.BedrockBrowserModel({apiKey,region:S.cfg.bedrockRegion||'us-east-1',modelId:modelId||'us.anthropic.claude-sonnet-4-20250514-v1:0'});
        else{a.messages.push({role:'assistant',content:`âŒ Unknown provider: ${provider}`});updateUI();return}
        const agent=new window._StrandsAgent({model,tools:window._BrowserTools||[],systemPrompt:cfg.systemPrompt||`You are ${a.name}, a helpful AI assistant running in the browser.`,printer:false});
        inst={agent,model};_browserAgentInstances.set(a.id,inst);
    } else {
        // Reuse existing instance (API key changes require page reload)
    }
    // Stream response
    a.streaming=true;a.streamText='';a.streamTools=[];a.status='streaming';updateUI();
    try{
        let currentText='';
        for await(const event of inst.agent.stream(txt)){
            if(!event||!event.type)continue;
            if(event.type==='modelContentBlockDeltaEvent'&&event.delta?.type==='textDelta'){currentText+=event.delta.text;a.streamText=currentText;schedRender(a.id)}
            else if(event.type==='modelContentBlockStartEvent'&&event.start?.type==='toolUseStart'){if(!a.streamTools)a.streamTools=[];a.streamTools.push({name:event.start.name,id:event.start.toolUseId,status:'running'});schedRender(a.id)}
            else if(event.type==='beforeToolCallEvent'){if(!a.streamTools)a.streamTools=[];a.streamTools.push({name:event.toolUse?.name||'',id:event.toolUse?.toolUseId,status:'running'});schedRender(a.id)}
            else if(event.type==='afterToolCallEvent'){const tc=(a.streamTools||[]).find(t=>t.name===(event.toolUse?.name));if(tc)tc.status='done';schedRender(a.id)}
        }
        const ft=currentText.trim();if(ft)a.messages.push({role:'assistant',content:ft});
        a.streaming=false;a.streamText='';a.streamTools=[];a.status='ready';
        addRing(a.id,'browser',ft.slice(0,150));
    }catch(e){
        a.messages.push({role:'assistant',content:`âŒ ${e.message}`});a.streaming=false;a.streamText='';a.streamTools=[];a.status='failed';
    }
    updatePanel(a.id);updateUI();
}

window.invokeAll=function(){const txt=prompt('Send to ALL agents:');if(!txt?.trim())return;let n=0;for(const[id,a]of S.agents){if(a.is_self)continue;a.messages.push({role:'user',content:txt});n++;if(id==='local:devduck'){if(S.localWs?.readyState===1)S.localWs.send(txt)}else if(a.type==='browser'){runBrowserAgent(a,txt)}else if(a.type==='github'){const p=id.split(':');S.relay?.send(JSON.stringify({type:'trigger_github',repo:p[1],workflow:p[2]||'agent.yml',prompt:txt,token:S.cfg.token}))}else{S.relay?.send(JSON.stringify({type:'invoke',agent_id:id,agent_type:a.type,prompt:txt,turn_id:crypto.randomUUID()}))}}S.relay?.send(JSON.stringify({type:'broadcast',message:txt}));addRing('mesh','local',`Invoked all (${n}): ${txt.slice(0,100)}`);updateUI();toast(`Sent to ${n} agents`)};
window.broadcastAll=function(){const txt=prompt('Broadcast to Zenoh peers:');if(!txt?.trim())return;S.relay?.send(JSON.stringify({type:'broadcast',message:txt}));toast('Broadcast sent')};
window.refresh=function(){
    S.relay?.send(JSON.stringify({type:'list_agents'}));
    // Also refresh GitHub agents explicitly
    if(S.cfg.token&&S.cfg.repos?.length){S.relay?.send(JSON.stringify({type:'list_github',token:S.cfg.token,repos:S.cfg.repos}))}
    updateUI();toast('Refreshing...')
};
window.clearAll=function(){if(!confirm('Clear all messages?'))return;S.agents.forEach(a=>a.messages=[]);updateUI()};
window.selectAgent=function(id){
    // Toggle selection for fan-out
    if(S.selectedAgents.has(id)){S.selectedAgents.delete(id)}else{S.selectedAgents.add(id)}
    S.activePanel=id;updateUI();updateChatTargets();
    const sid=safeId(id);E(`pnl-${sid}`)?.scrollIntoView({behavior:'smooth'});
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT TARGETS DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateChatTargets(){
    const el=E('chatTargets');if(!el)return;
    if(S.selectedAgents.size===0){el.innerHTML='<span style="color:var(--t3)">Click agents in sidebar to select targets</span>';E('chatInput').placeholder='Select agents first, then type...';return}
    el.innerHTML=[...S.selectedAgents].map(id=>{const a=S.agents.get(id);return`<span class="ct-tag">${esc(a?.name||id)}</span>`}).join('')+`<span style="color:var(--t3);cursor:pointer" onclick="S.selectedAgents.clear();updateUI();updateChatTargets()">âœ• clear</span>`;
    E('chatInput').placeholder=`Message ${S.selectedAgents.size} agent${S.selectedAgents.size>1?'s':''}...`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT / DELETE AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openEdit=function(id,ev){
    if(ev)ev.stopPropagation();
    const a=S.agents.get(id);if(!a)return;
    E('editId').value=id;
    E('editTitle').textContent=a.name||id;
    E('editName').value=a.name||'';
    E('editColor').value=a.color||'#ff375f';
    E('editPrompt').value=a.config?.systemPrompt||'';
    E('editTools').value=a.config?.tools||'';
    E('editModel').value=a.config?.model||'';
    // Show provider fields for browser agents
    const isBrowser=a.type==='browser';
    E('editProviderWrap').style.display=isBrowser?'block':'none';
    E('editModelIdWrap').style.display=isBrowser?'block':'none';
    if(isBrowser){E('editProvider').value=a.config?.provider||'anthropic';E('editModelId').value=a.config?.modelId||''}
    E('editModal').classList.add('active');
};

window.saveEdit=function(){
    const id=E('editId').value;const a=S.agents.get(id);if(!a)return;
    const name=E('editName').value.trim()||a.name;
    const color=E('editColor').value;
    const systemPrompt=E('editPrompt').value.trim();
    const tools=E('editTools').value.trim()||null;
    const model=E('editModel').value.trim()||null;
    // Update agent
    a.name=name;a.color=color;
    if(!a.config)a.config={};
    a.config.systemPrompt=systemPrompt;a.config.tools=tools;a.config.model=model;
    a.description=(systemPrompt||'').slice(0,60)+'...';
    if(a.type==='browser'){a.config.provider=E('editProvider').value;a.config.modelId=E('editModelId').value.trim()||null;a.description=`${a.config.provider} ${a.config.modelId||DEFAULT_MODELS[a.config.provider]||''}`;_browserAgentInstances.delete(id)}
    // Persist
    if(a.type==='virtual'){const idx=S.cfg.virtualAgents.findIndex(v=>v.id===id);if(idx>=0)S.cfg.virtualAgents[idx]={...S.cfg.virtualAgents[idx],name,color,systemPrompt,tools,model};saveCfg()}
    if(a.type==='browser'){const idx=S.cfg.browserAgents.findIndex(v=>v.id===id);if(idx>=0)S.cfg.browserAgents[idx]={...S.cfg.browserAgents[idx],name,color,systemPrompt,provider:a.config.provider,modelId:a.config.modelId};saveCfg()}
    closeModal('editModal');updateUI();toast(`"${name}" updated`,'ok');
};

window.deleteAgent=function(){
    const id=E('editId').value;const a=S.agents.get(id);if(!a)return;
    if(!confirm(`Delete agent "${a.name||id}"?`))return;
    S.agents.delete(id);
    if(a.type==='virtual'){S.cfg.virtualAgents=S.cfg.virtualAgents.filter(v=>v.id!==id);saveCfg()}
    if(a.type==='browser'){S.cfg.browserAgents=S.cfg.browserAgents.filter(v=>v.id!==id);saveCfg()}
    closeModal('editModal');updateUI();toast(`"${a.name||id}" deleted`);
};

window.deleteAgentDirect=function(id,ev){
    if(ev)ev.stopPropagation();
    const a=S.agents.get(id);if(!a)return;
    if(!confirm(`Delete "${a.name||id}"?`))return;
    S.agents.delete(id);
    if(a.type==='virtual'){S.cfg.virtualAgents=S.cfg.virtualAgents.filter(v=>v.id!==id);saveCfg()}
    if(a.type==='browser'){S.cfg.browserAgents=S.cfg.browserAgents.filter(v=>v.id!==id);saveCfg()}
    updateUI();toast(`"${a.name||id}" deleted`);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT SEND â€” Fan-out to selected agents + ephemeral response
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _ephTimer=null,_ephPinned=false;
function showEph(html,streaming=false){
    const el=E('ephResponse');if(!el)return;
    if(_ephTimer){clearTimeout(_ephTimer);_ephTimer=null}
    el.innerHTML=`<div class="eph-hdr"><span style="font-size:9px;color:var(--t3)">${streaming?'â³ streaming...':'âœ… done'}</span><button class="eph-pin ${_ephPinned?'pinned':''}" onclick="togglePin()">ğŸ“Œ ${_ephPinned?'unpin':'pin'}</button></div><div class="eph-body">${html}</div>`;
    el.classList.add('active');el.classList.remove('fading');
    el.scrollTop=el.scrollHeight;
    if(!streaming&&!_ephPinned){_ephTimer=setTimeout(()=>{el.classList.add('fading');setTimeout(()=>el.classList.remove('active','fading'),400)},8000)}
}
window.togglePin=function(){_ephPinned=!_ephPinned;const pin=document.querySelector('.eph-pin');if(pin){pin.classList.toggle('pinned',_ephPinned);pin.textContent=`ğŸ“Œ ${_ephPinned?'unpin':'pin'}`}if(_ephPinned&&_ephTimer){clearTimeout(_ephTimer);_ephTimer=null}};

let _chatBusy=false;
window.chatSend=function(){
    const input=E('chatInput');const txt=input?.value?.trim();if(!txt||_chatBusy)return;
    const targets=[...S.selectedAgents];
    // If nothing selected, send to local devduck as orchestration
    if(targets.length===0){
        // Route through local devduck with ring context
        if(!S.localWs||S.localWs.readyState!==1){toast('No DevDuck connected','err');return}
        input.value='';input.style.height='auto';
        _chatBusy=true;E('chatSendBtn').disabled=true;
        const ringBlock=S.ring.slice(-10).map(e=>`[${e.agent_id}] ${e.text||''}`).join('\n');
        const agentList=[...S.agents.values()].map(a=>`â€¢ ${a.id} (${a.type}) â€” ${a.name||a.id}`).join('\n');
        const prompt=`[Mesh Context]\nAgents: ${agentList}\nRing:\n${ringBlock||'(none)'}\n\n${txt}`;
        S.localWs.send(prompt);
        showEph('<div style="color:var(--t3)">thinking...</div>',true);
        // Capture the response
        const origOnMsg=S.localWs.onmessage;let streamText='';
        S.localWs.onmessage=e=>{
            try{const msg=JSON.parse(e.data);
                if(msg.type==='chunk'){streamText+=(msg.data||'');try{showEph(marked.parse(streamText),true)}catch{showEph('<pre>'+esc(streamText)+'</pre>',true)}}
                else if(msg.type==='tool_start'){showEph((streamText?marked.parse(streamText):'')+'<div style="font-size:9px;display:inline-block;padding:2px 6px;background:rgba(255,149,0,.12);border-radius:5px;color:var(--accent);margin:2px">â³ '+esc(msg.data||'')+'</div>',true)}
                else if(msg.type==='turn_end'){
                    const ft=(streamText).trim()||msg.response||'';
                    if(ft)try{showEph(marked.parse(ft),false)}catch{showEph('<pre>'+esc(ft)+'</pre>',false)}
                    _chatBusy=false;E('chatSendBtn').disabled=false;
                    S.localWs.onmessage=origOnMsg;
                    addRing('chat','local',ft.slice(0,150));
                }
                else if(msg.type==='turn_start'){streamText=''}
                else if(msg.type==='error'){showEph(`<div style="color:var(--red)">âŒ ${msg.data||msg.error||'unknown error'}</div>`,false);_chatBusy=false;E('chatSendBtn').disabled=false;S.localWs.onmessage=origOnMsg}
                else{origOnMsg(e)} // pass through non-chat messages
            }catch(err){origOnMsg(e)}
        };
        addRing('chat','local',`ğŸ’¬ ${txt.slice(0,120)}`);
        return;
    }

    input.value='';input.style.height='auto';
    // Fan-out: send to every selected agent
    addRing('chat','local',`â†’ [${targets.map(id=>S.agents.get(id)?.name||id).join(', ')}]: ${txt.slice(0,100)}`);
    for(const id of targets){
        // For browser agents, inject ring context into prompt
        const a=S.agents.get(id);
        if(a&&a.type==='browser'){
            const ringBlock=S.ring.slice(-8).map(e=>`[${e.agent_id}] ${e.text||''}`).join('\n');
            const enriched=ringBlock?`[Ring Context]\n${ringBlock}\n\n[User Query]\n${txt}`:txt;
            sendMsg(id,enriched);
        } else {
            sendMsg(id,txt);
        }
    }
    toast(`Sent to ${targets.length} agent${targets.length>1?'s':''}`);
};

// Override sendMsg to accept optional text param for fan-out
const _origSendMsg=window.sendMsg;
window.sendMsg=function(agentId,textOverride){
    if(textOverride){
        const a=S.agents.get(agentId);
        if(a){
            a.messages.push({role:'user',content:textOverride});
            addRing('browser:user',a.type||'browser',`â†’ ${agentId}: ${textOverride.slice(0,120)}`);
            if(agentId==='local:devduck'){if(S.localWs&&S.localWs.readyState===1)S.localWs.send(textOverride)}
            else if(a.type==='browser'){runBrowserAgent(a,textOverride)}
            else if(a.type==='virtual'){if(S.localWs&&S.localWs.readyState===1){const p={type:'message',text:textOverride,turn_id:crypto.randomUUID().slice(0,8),timestamp:Date.now()};if(a.config?.systemPrompt)p.system_prompt=a.config.systemPrompt;S.localWs.send(JSON.stringify(p));a.streaming=true;a.streamText='';a.status='streaming';a._turnId=p.turn_id}}
            else if(a.type==='github'){const p=agentId.split(':');S.relay?.send(JSON.stringify({type:'trigger_github',repo:p[1],workflow:p[2]||'agent.yml',prompt:textOverride,token:S.cfg.token}))}
            else{S.relay?.send(JSON.stringify({type:'invoke',agent_id:agentId,agent_type:a.type,prompt:textOverride,turn_id:crypto.randomUUID(),system_prompt:a.config?.systemPrompt,tools:a.config?.tools,model:a.config?.model}))}
            updateUI();
        }
    } else {
        _origSendMsg(agentId);
    }
};

// Virtual agent responses come through local WS â€” intercept by turn_id
const _origLocalMsg=handleLocalMsg;
// Override handleLocalMsg to route virtual agent responses
const origHandleLocal=handleLocalMsg;
// We need to intercept local WS messages for virtual agents
function handleLocalMsgV2(msg){
    // Check if any virtual agent is waiting for this turn
    for(const[id,a]of S.agents){
        if(a.type==='virtual'&&a._turnId&&a.streaming){
            // Route messages to virtual agent panel
            if(msg.type==='turn_start'){a.streamText='';a.streamTools=[];a.status='streaming';schedRender(id);return}
            if(msg.type==='chunk'){a.streamText=(a.streamText||'')+(msg.data||'');schedRender(id);return}
            if(msg.type==='tool_start'){if(!a.streamTools)a.streamTools=[];a.streamTools.push({name:msg.data||'',id:msg.tool_id,status:'running'});schedRender(id);return}
            if(msg.type==='tool_end'){const tc=(a.streamTools||[]).find(t=>t.id===msg.tool_id);if(tc)tc.status='done';schedRender(id);return}
            if(msg.type==='turn_end'){const ft=(a.streamText||'').trim();if(ft)a.messages.push({role:'assistant',content:ft});a.streaming=false;a.streamTools=[];a.status='ready';a._turnId=null;addRing(id,'virtual',ft.slice(0,150));updatePanel(id);updateUI();return}
            if(msg.type==='error'){a.messages.push({role:'assistant',content:`âŒ ${msg.data||msg.error||'unknown error'}`});a.streaming=false;a.status='ready';a._turnId=null;updatePanel(id);updateUI();return}
        }
    }
    // Fallback to local devduck handler
    handleLocalMsg(msg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RING CONTEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRing(aid,atype,txt){const entry={agent_id:aid,agent_type:atype,text:txt||'',timestamp:Date.now()/1000};S.ring.push(entry);if(S.ring.length>100)S.ring=S.ring.slice(-100);renderRing();
// â”€â”€ Bidirectional sync: push to relay so CLI/AgentCore see browser ring â”€â”€
if(S.relay&&S.relayOk){S.relay.send(JSON.stringify({type:'add_ring',agent_id:aid,agent_type:atype,text:txt||''}))}}
window.clearRing=()=>{S.ring=[];renderRing()};
function renderRing(){const el=E('ringBody');const entries=S.ring.slice(-30).reverse();if(!entries.length){el.innerHTML='<div class="empty-pnl"><div style="font-size:9px;color:var(--t3)">Activity appears here</div></div>';return}el.innerHTML=entries.map(e=>{const t=new Date((e.timestamp||0)*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});return`<div class="re"><div class="re-hdr"><span class="re-agent">${esc(e.agent_id)}</span><span class="badge ${e.agent_type}">${e.agent_type}</span><span class="re-time">${t}</span></div><div class="re-txt">${esc(e.text||'')}</div></div>`}).join('')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateUI(){updateStatus();updateStats();updateAgentsList();updatePanels()}

function updateStatus(){
    const d=E('statusDot'),t=E('statusTxt');
    if(S.relayOk&&S.localOk){d.className='dot on';t.textContent=`relay:${S.cfg.relayPort} + local:${S.cfg.localPort}`}
    else if(S.relayOk){d.className='dot on';t.textContent=`relay:${S.cfg.relayPort}`}
    else if(S.localOk){d.className='dot wait';t.textContent=`local:${S.cfg.localPort}`}
    else{d.className='dot';t.textContent='disconnected'}
}

function updateStats(){
    const a=[...S.agents.values()];
    const zenohCount=a.filter(x=>x.type==='zenoh').length;
    console.log('ğŸ“Š updateStats: total=', a.length, 'zenoh=', zenohCount, 'types:', a.map(x=>x.type));
    E('cntLocal').textContent=a.filter(x=>x.type==='local').length;
    E('cntVirtual').textContent=a.filter(x=>x.type==='virtual').length;
    E('cntBrowser').textContent=a.filter(x=>x.type==='browser').length;
    E('cntGithub').textContent=a.filter(x=>x.type==='github').length;
    E('cntCloud').textContent=a.filter(x=>x.type==='agentcore').length;
    E('cntZenoh').textContent=a.filter(x=>x.type==='zenoh').length;
}

function updateAgentsList(){
    const el=E('agentsList');const agents=[...S.agents.values()];
    if(!agents.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No agents discovered</div>';return}
    const groups={local:[],virtual:[],browser:[],github:[],agentcore:[],zenoh:[]};
    for(const a of agents)(groups[a.type]||(groups.other=groups.other||[])).push(a);
    let html='';
    for(const[type,list]of Object.entries(groups)){
        if(!list||!list.length)continue;
        html+=`<div class="sec-hdr"><span class="sec-icon">${ICONS[type]||'ğŸ¤–'}</span><span class="sec-title">${type}</span><span class="sec-cnt">${list.length}</span></div>`;
        for(const a of list){
            const isAct=S.activePanel===a.id;const eid=a.id.replace(/'/g,"\\'");
            const canEdit=['virtual','browser'].includes(a.type);
            const isSel=S.selectedAgents.has(a.id);
            html+=`<div class="ac ${isAct?'active':''} ${isSel?'selected':''}" onclick="selectAgent('${eid}')"><div class="ac-hdr"><span class="ac-sel">${isSel?'âœ“':''}</span><span class="ac-dot" style="background:${a.color||`var(--c-${a.type})`}"></span><div class="ac-info"><div class="ac-name">${esc(a.name||a.id)}${a.is_self?' <span style="font-size:8px;color:var(--c-zenoh)">(you)</span>':''}</div><div class="ac-meta">${a.type==='zenoh'&&a.tool_count?`${esc(a.model||'')} Â· ${a.tool_count} tools`:a.type==='github'?`${esc(a.repo||'')} Â· ${esc(a.workflow||'agent.yml')}${a.last_run?` Â· ${a.last_run.conclusion||a.last_run.status||'?'}`:''}`+`${a.stars?` Â· â­${a.stars}`:''}`:esc(a.description||a.repo||a.model||a.hostname||'')}</div></div>${canEdit?`<div class="ac-acts"><button class="ac-ab" onclick="openEdit('${eid}',event)" title="Edit">âœ</button><button class="ac-ab del" onclick="deleteAgentDirect('${eid}',event)" title="Delete">âœ•</button></div>`:''}<span class="ac-st ${a.status||'ready'}">${a.streaming?'streaming':(a.status||'ready')}</span>${a.type==='github'&&a.run_url?`<a href="${a.run_url}" target="_blank" style="font-size:7px;color:var(--accent);text-decoration:none;margin-left:3px" title="View run">ğŸ”—</a>`:''}</div></div>`;
        }
    }
    el.innerHTML=html;
}

function updatePanels(){
    const el=E('panels');const agents=[...S.agents.values()];
    if(!agents.length){el.innerHTML=`<div class="empty-pnl"><div class="empty-icon">ğŸ¦†</div><div class="empty-txt">No agents yet.<br><br>â€¢ DevDuck relay on port ${S.cfg.relayPort}<br>â€¢ Local DevDuck on port ${S.cfg.localPort}<br>â€¢ Create Virtual or Browser agents</div></div>`;return}
    el.innerHTML=agents.map(a=>{
        const sid=safeId(a.id);let body='';
        if(a.messages?.length)body+=a.messages.map(m=>m.role==='user'?`<div style="margin-bottom:8px;padding:7px 10px;background:rgba(255,149,0,.1);border-radius:7px;font-size:11px"><strong>You:</strong> ${esc(m.content)}</div>`:`<div style="margin-bottom:8px">${marked.parse(m.content)}</div>`).join('');
        if(a.streaming&&a.streamText){try{body+=`<div style="margin-bottom:8px">${marked.parse(a.streamText)}</div>`}catch{body+=`<pre>${esc(a.streamText)}</pre>`}}
        let tools='';if(a.streamTools?.length)tools='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">'+a.streamTools.map(tc=>`<span style="font-size:9px;padding:2px 6px;background:rgba(255,149,0,.12);border-radius:5px;color:var(--accent)">${tc.status==='done'?'âœ…':'â³'} ${esc(tc.name)}</span>`).join('')+'</div>';
        const content=tools+body;
        return`<div class="pnl ${a.type} ${a.streaming?'streaming':''}" id="pnl-${sid}"><div class="pnl-hdr"><span class="pnl-icon">${ICONS[a.type]||'ğŸ¤–'}</span><span class="pnl-name">${esc(a.name||a.id)}</span><div class="pnl-acts">${['virtual','browser'].includes(a.type)?`<button class="pnl-ab" onclick="openEdit('${a.id.replace(/'/g,"\\'")}',event)" title="Edit">âœ</button><button class="pnl-ab del" onclick="deleteAgentDirect('${a.id.replace(/'/g,"\\'")}',event)" title="Delete">âœ•</button>`:''}</div><div class="pnl-badges">${a.run_url?`<a href="${a.run_url}" target="_blank" style="font-size:8px;color:var(--accent);text-decoration:none" title="View run">ğŸ”—</a>`:''}<span class="badge ${a.type}">${a.type}</span><span class="ac-st ${a.streaming?'streaming':(a.status||'ready')}">${a.streaming?'streaming':(a.status||'ready')}</span></div></div><div class="pnl-body ${a.streaming?'cursor':''}" id="body-${sid}">${content||`<div class="empty-pnl"><div class="empty-icon">${ICONS[a.type]||'ğŸ¤–'}</div><div class="empty-txt">${getDesc(a)}</div></div>`}</div><div class="pnl-ft"><input class="pnl-in" id="in-${sid}" data-aid="${a.id}" placeholder="Message ${esc(a.name||a.id)}..." onkeydown="if(event.key==='Enter'){event.preventDefault();sendMsg(this.dataset.aid)}"><button class="pnl-send" onclick="sendMsg('${a.id.replace(/'/g,"\\'")}')" ${a.streaming?'disabled':''}>${a.type==='github'?'ğŸš€':'â†’'}</button></div></div>`
    }).join('');
    for(const[id,a]of S.agents){if(a.streaming||a.messages?.length){const b=E(`body-${safeId(id)}`);if(b)b.scrollTop=b.scrollHeight}}
}

function updatePanel(id){
    const a=S.agents.get(id);if(!a)return;const sid=safeId(id);const body=E(`body-${sid}`);if(!body)return;
    let html='';
    if(a.messages?.length)html+=a.messages.map(m=>m.role==='user'?`<div style="margin-bottom:8px;padding:7px 10px;background:rgba(255,149,0,.1);border-radius:7px;font-size:11px"><strong>You:</strong> ${esc(m.content)}</div>`:`<div style="margin-bottom:8px">${marked.parse(m.content)}</div>`).join('');
    if(a.streamTools?.length)html+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">'+a.streamTools.map(tc=>`<span style="font-size:9px;padding:2px 6px;background:rgba(255,149,0,.12);border-radius:5px;color:var(--accent)">${tc.status==='done'?'âœ…':'â³'} ${esc(tc.name)}</span>`).join('')+'</div>';
    if(a.streaming&&a.streamText){try{html+=marked.parse(a.streamText)}catch{html+='<pre>'+esc(a.streamText)+'</pre>'}}
    if(html){body.innerHTML=html;body.scrollTop=body.scrollHeight}
    const pnl=E(`pnl-${sid}`);if(pnl)pnl.classList.toggle('streaming',!!a.streaming);
}

function getDesc(a){
    if(a.type==='local')return`<strong>Local DevDuck</strong><br><br>Direct WebSocket chat`;
    if(a.type==='virtual')return`<strong>Virtual Agent</strong><br><br>${esc(a.config?.systemPrompt?.slice(0,100)||'')}...<br>Routes through DevDuck backend`;
    if(a.type==='browser')return`<strong>Browser Agent</strong><br><br>${a.config?.provider||'unknown'} â€” runs in-browser`;
    if(a.type==='github')return`<strong>${esc(a.repo||a.name)}</strong><br><br>${esc(a.description||'GitHub Actions agent')}<br>${a.workflow?`Workflow: <code>${esc(a.workflow)}</code><br>`:''}${a.stars?`â­ ${a.stars} stars<br>`:''}${a.last_run?`Last run: ${a.last_run.conclusion||a.last_run.status||'?'}<br>`:''}Send prompt to trigger workflow`;
    if(a.type==='agentcore')return`<strong>AgentCore</strong><br><br>Cloud: ${a.region||'us-west-2'}<br>${esc(a.name||a.id)}`;
    if(a.type==='zenoh'){let d=`<strong>Zenoh Peer</strong><br>Host: ${esc(a.hostname||'?')} &middot; Model: ${esc(a.model||'?')}`;if(a.is_self)d+=`<br><em style="color:var(--c-zenoh)">This is you (local DevDuck)</em>`;if(a.cwd)d+=`<br>ğŸ“ <code>${esc(a.cwd)}</code>`;if(a.pplatform)d+=`<br>ğŸ’» ${esc(a.pplatform)}`;if(a.system_prompt)d+=`<br><br><strong>System Prompt:</strong><br><span style="color:var(--t2);font-size:10px">${esc(a.system_prompt)}</span>`;if(a.tools?.length){d+=`<br><br><strong>Tools (${a.tool_count||a.tools.length}):</strong><div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:4px">${a.tools.map(t=>`<span style="font-size:8px;padding:2px 6px;background:rgba(48,209,88,.1);border:1px solid rgba(48,209,88,.2);border-radius:4px;color:var(--c-zenoh)">${esc(t)}</span>`).join('')}</div>`}return d}
    return'Agent ready';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESH AGENT â€” Auto-created browser agent for cross-mesh communication
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMeshAgent(){
    // Find or create the mesh browser agent
    for(const[id,a]of S.agents){if(a.type==='browser'&&a._isMeshAgent)return a}
    return null;
}

function ensureMeshAgent(){
    if(getMeshAgent())return;
    // Auto-create a mesh browser agent if we have any API key configured
    const provider=S.cfg.bedrockKey?'bedrock':S.cfg.anthropicKey?'anthropic':S.cfg.openaiKey?'openai':null;
    if(!provider)return; // No API key, can't create
    const id='browser:mesh-chat';
    const cfg={id,name:'ğŸ•¸ï¸ mesh',color:'#00d4ff',type:'browser',provider,
        modelId:null, // use default
        systemPrompt:`You are the Mesh Chat agent running in the browser. You are part of a unified agent mesh that includes CLI DevDuck terminals (via Zenoh P2P), cloud agents (AgentCore), GitHub agents, and other browser agents.

Your role:
- You can be invoked by CLI terminals, zenoh peers, or other agents
- You have access to browser tools (render_ui, javascript_eval, fetch_url, storage)
- When invoked from the mesh, process the request and respond helpfully
- You can see the ring context showing what other agents are working on
- Be concise and helpful

You are connected to the DevDuck mesh network.`};
    S.cfg.browserAgents.push(cfg);saveCfg();
    const a={id,type:'browser',name:cfg.name,color:cfg.color,status:'ready',
        description:`${provider} (mesh chat)`,config:cfg,_isMeshAgent:true};
    registerAgent(a);
    console.log('ğŸŒ ğŸ•¸ï¸ mesh agent auto-created with',provider);
    return a;
}

async function handleBrowserInvoke(msg){
    // Incoming invoke from CLI/zenoh â€” run our mesh agent
    const prompt=msg.prompt||'';
    const turnId=msg.turn_id||'';
    const fromWsId=msg.from_ws_id||'';
    const zenohRequesterId=msg.zenoh_requester_id||'';
    
    console.log('ğŸ§  Browser invoke received:',prompt.slice(0,80),'from:',fromWsId||zenohRequesterId);
    
    // Find or create mesh agent
    let meshAgent=getMeshAgent();
    if(!meshAgent){ensureMeshAgent();meshAgent=getMeshAgent()}
    if(!meshAgent){
        // No API key â€” send error back
        if(S.relay&&S.relayOk){
            S.relay.send(JSON.stringify({type:'browser_invoke_response',turn_id:turnId,response:'âŒ No API key configured for browser agent. Open Settings in mesh.html.',requester_ws_id:fromWsId,zenoh_requester_id:zenohRequesterId}));
        }
        return;
    }
    
    // Add the query to mesh agent's messages for display
    meshAgent.messages.push({role:'user',content:`[from ${fromWsId||zenohRequesterId||'mesh'}] ${prompt}`});
    updateUI();
    
    // Run the browser agent
    meshAgent.streaming=true;meshAgent.streamText='';meshAgent.streamTools=[];meshAgent.status='streaming';
    updateUI();
    
    try{
        // Stream chunks back to the relay for zenoh forwarding
        const cfg=meshAgent.config||{};
        const provider=cfg.provider||'anthropic';
        let apiKey='';
        if(provider==='anthropic')apiKey=S.cfg.anthropicKey;
        else if(provider==='openai')apiKey=S.cfg.openaiKey;
        else if(provider==='bedrock')apiKey=S.cfg.bedrockKey;
        
        if(!apiKey){throw new Error(`No ${provider} API key configured`)}
        
        let inst=_browserAgentInstances.get(meshAgent.id);
        if(!inst){
            let model;const Models=window._BrowserModels;
            if(provider==='anthropic')model=new Models.AnthropicBrowserModel({apiKey,modelId:cfg.modelId||'claude-sonnet-4-20250514'});
            else if(provider==='openai')model=new Models.OpenAIBrowserModel({apiKey,modelId:cfg.modelId||'gpt-4o'});
            else if(provider==='bedrock')model=new Models.BedrockBrowserModel({apiKey,region:S.cfg.bedrockRegion||'us-east-1',modelId:cfg.modelId||'us.anthropic.claude-sonnet-4-20250514-v1:0'});
            else throw new Error(`Unknown provider: ${provider}`);
            const agent=new window._StrandsAgent({model,tools:window._BrowserTools||[],systemPrompt:cfg.systemPrompt||'You are a mesh browser agent.',printer:false});
            inst={agent,model};_browserAgentInstances.set(meshAgent.id,inst);
        }
        
        let currentText='';
        for await(const event of inst.agent.stream(prompt)){
            if(!event||!event.type)continue;
            if(event.type==='modelContentBlockDeltaEvent'&&event.delta?.type==='textDelta'){
                currentText+=event.delta.text;
                meshAgent.streamText=currentText;
                schedRender(meshAgent.id);
                // Stream chunk back to relay for zenoh
                if(S.relay&&S.relayOk&&zenohRequesterId){
                    S.relay.send(JSON.stringify({type:'browser_stream_chunk',turn_id:turnId,zenoh_requester_id:zenohRequesterId,data:event.delta.text}));
                }
            }
        }
        
        const ft=currentText.trim();
        if(ft)meshAgent.messages.push({role:'assistant',content:ft});
        meshAgent.streaming=false;meshAgent.streamText='';meshAgent.streamTools=[];meshAgent.status='ready';
        
        // Send final response back to relay
        if(S.relay&&S.relayOk){
            S.relay.send(JSON.stringify({type:'browser_invoke_response',turn_id:turnId,response:ft,requester_ws_id:fromWsId,zenoh_requester_id:zenohRequesterId}));
        }
        addRing(meshAgent.id,'browser',ft.slice(0,150));
    }catch(e){
        meshAgent.messages.push({role:'assistant',content:`âŒ ${e.message}`});
        meshAgent.streaming=false;meshAgent.status='failed';
        if(S.relay&&S.relayOk){
            S.relay.send(JSON.stringify({type:'browser_invoke_response',turn_id:turnId,response:`âŒ ${e.message}`,requester_ws_id:fromWsId,zenoh_requester_id:zenohRequesterId}));
        }
    }
    updatePanel(meshAgent.id);updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function E(id){return document.getElementById(id)}
function safeId(id){return id.replace(/[^a-zA-Z0-9_-]/g,'_')}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function closeModal(id){E(id)?.classList.remove('active')}
window.closeModal=closeModal;
function toast(msg,type=''){const t=E('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>t.classList.remove('show'),3000)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
console.log('%cğŸ¦† one â€” unified mesh','font-size:18px;font-weight:bold;color:#ff9500');
loadCfg();

// ğŸ”‘ Listen for credential changes from other tabs via AgentMesh
window.addEventListener('agimesh:credentials',(e)=>{
    const creds=e.detail;
    if(creds.anthropic?.apiKey)S.cfg.anthropicKey=creds.anthropic.apiKey;
    if(creds.openai?.apiKey)S.cfg.openaiKey=creds.openai.apiKey;
    if(creds.bedrock?.apiKey)S.cfg.bedrockKey=creds.bedrock.apiKey;
    if(creds.bedrock?.region)S.cfg.bedrockRegion=creds.bedrock.region;
    // Update settings form if open
    const ak=E('sAnthropicKey');if(ak)ak.value=S.cfg.anthropicKey||'';
    const ok=E('sOpenaiKey');if(ok)ok.value=S.cfg.openaiKey||'';
    const bk=E('sBedrockKey');if(bk)bk.value=S.cfg.bedrockKey||'';
    const br=E('sBedrockRegion');if(br)br.value=S.cfg.bedrockRegion||'us-east-1';
    _browserAgentInstances.clear();// Re-create agents with new keys
    ensureMeshAgent();
    toast('Credentials synced from another tab','ok');
});

// Restore virtual agents from config
for(const cfg of S.cfg.virtualAgents||[]){
    registerAgent({id:cfg.id,type:'virtual',name:cfg.name,color:cfg.color,status:'ready',description:(cfg.systemPrompt||'').slice(0,60)+'...',config:cfg});
}
// Restore browser agents from config
for(const cfg of S.cfg.browserAgents||[]){
    registerAgent({id:cfg.id,type:'browser',name:cfg.name,color:cfg.color,status:'ready',description:`${cfg.provider} ${cfg.modelId||DEFAULT_MODELS[cfg.provider]||''}`,config:cfg});
}

updateUI();renderRing();
updateChatTargets();

// Auto-create mesh chat agent if API key is configured
ensureMeshAgent();

// Patch local WS handler for virtual agent routing
const _origConnectLocal=connectLocal;
window._connectLocalPatched=false;
const origConnLocal=connectLocal;
function connectLocalPatched(){
    const port=S.cfg.localPort||10001;
    const ws=new WebSocket(`ws://localhost:${port}`);
    ws.onopen=()=>{
        S.localWs=ws;S.localOk=true;
        registerAgent({id:'local:devduck',type:'local',name:'ğŸ¦† Local DevDuck',status:'ready',description:`ws://localhost:${port}`});
        updateStatus();updateUI();
    };
    ws.onmessage=e=>{try{const msg=JSON.parse(e.data);handleLocalMsgV2(msg)}catch(err){console.warn('Local WS non-JSON:',e.data?.slice?.(0,100))}};
    ws.onerror=()=>{};
    ws.onclose=()=>{S.localOk=false;S.localWs=null;const a=S.agents.get('local:devduck');if(a)a.status='offline';updateStatus();updateUI();setTimeout(connectLocalPatched,5000)};
}

connectRelay();
connectLocalWithVoice();

// ğŸ”‘ Delayed credential sync after AgentMesh initializes (agent-mesh.js loads after this module)
setTimeout(()=>{
    if(window.AgentMesh?.getCredentials){
        const meshCreds=window.AgentMesh.getCredentials();
        let updated=false;
        if(meshCreds.anthropic?.apiKey&&!S.cfg.anthropicKey){S.cfg.anthropicKey=meshCreds.anthropic.apiKey;updated=true}
        if(meshCreds.openai?.apiKey&&!S.cfg.openaiKey){S.cfg.openaiKey=meshCreds.openai.apiKey;updated=true}
        if(meshCreds.bedrock?.apiKey&&!S.cfg.bedrockKey){S.cfg.bedrockKey=meshCreds.bedrock.apiKey;updated=true}
        if(meshCreds.bedrock?.region&&!S.cfg.bedrockRegion){S.cfg.bedrockRegion=meshCreds.bedrock.region;updated=true}
        if(updated){
            console.log('ğŸ”‘ Loaded credentials from AgentMesh unified storage');
            _browserAgentInstances.clear();
            ensureMeshAgent();
        }
    }
},600);

window.S=S;window.toast=toast;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE â€” Speech-to-Speech via Local DevDuck WS (port 10001)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const VOICE_PROVIDERS={
    novasonic:{label:'Nova Sonic',voices:[{id:'tiffany',label:'Tiffany'},{id:'matthew',label:'Matthew'},{id:'amy',label:'Amy'}]},
    gemini_live:{label:'Gemini Live',voices:[{id:'Kore',label:'Kore'},{id:'Puck',label:'Puck'},{id:'Charon',label:'Charon'}]},
    openai:{label:'OpenAI',voices:[{id:'alloy',label:'Alloy'},{id:'echo',label:'Echo'},{id:'shimmer',label:'Shimmer'}]},
};

const V={
    active:false, pending:false,
    audioCtx:null, mediaStream:null, processor:null,
    playCtx:null, workletNode:null, workletReady:false,
};

// AudioWorklet processor
const AUDIO_WORKLET_CODE=`
class AudioProcessor extends AudioWorkletProcessor {
  constructor(){super();this.buffer=new Float32Array(0);this.port.onmessage=(e)=>{if(e.data.type==='audio'){const n=new Float32Array(this.buffer.length+e.data.samples.length);n.set(this.buffer);n.set(e.data.samples,this.buffer.length);this.buffer=n}else if(e.data.type==='clear'){this.buffer=new Float32Array(0)}}}
  process(i,o){const out=o[0][0];const n=out.length;if(this.buffer.length>=n){out.set(this.buffer.subarray(0,n));this.buffer=this.buffer.slice(n)}else if(this.buffer.length>0){out.set(this.buffer);for(let i=this.buffer.length;i<n;i++)out[i]=0;this.buffer=new Float32Array(0)}else{out.fill(0)}return true}
}
registerProcessor('audio-processor',AudioProcessor);
`;

// Populate voice select dropdown
function populateVoices(){
    const sel=E('voiceSelect');if(!sel)return;
    const prov=E('voiceProvider')?.value||S.cfg.voiceProvider||'novasonic';
    const voices=VOICE_PROVIDERS[prov]?.voices||[];
    sel.innerHTML=voices.map(v=>`<option value="${v.id}"${v.id===S.cfg.voiceVoice?' selected':''}>${v.label}</option>`).join('');
}
window.voiceCfgChanged=function(){
    S.cfg.voiceProvider=E('voiceProvider')?.value||'novasonic';
    populateVoices();
    S.cfg.voiceVoice=E('voiceSelect')?.value||'';
    saveCfg();
};

// Show/hide voice UI
function setVoiceUI(state){
    const btn=E('micBtn');const vis=E('voiceVis');const cfg=E('voiceCfg');
    if(!btn)return;
    if(state==='active'){
        btn.className='mic-btn active';btn.textContent='ğŸ¤';
        vis.style.display='flex';vis.innerHTML=Array.from({length:20}).map((_,i)=>`<div class="bar" style="animation-delay:${i*30}ms"></div>`).join('');
        cfg.style.display='flex';
    }else if(state==='pending'){
        btn.className='mic-btn pending';btn.textContent='â³';
        vis.style.display='none';cfg.style.display='flex';
    }else{
        btn.className='mic-btn';btn.textContent='ğŸ¤';
        vis.style.display='none';
        E('voiceTranscript').style.display='none';
        // Keep cfg visible so user can pick provider before starting
        cfg.style.display='flex';
    }
}

function showTranscript(text,role){
    const el=E('voiceTranscript');if(!el)return;
    el.style.display='block';
    el.className=`voice-transcript ${role}`;
    el.textContent=`${role==='user'?'ğŸ¤':'ğŸ”Š'} ${text}`;
}

// Mic capture AudioWorklet processor
const MIC_WORKLET_CODE=`
class MicCaptureProcessor extends AudioWorkletProcessor {
  constructor(){super();this.active=true;this.port.onmessage=(e)=>{if(e.data.type==='stop')this.active=false}}
  process(inputs){
    if(!this.active)return false;
    const input=inputs[0]?.[0];
    if(input&&input.length>0){this.port.postMessage({type:'audio',samples:new Float32Array(input)})}
    return true;
  }
}
registerProcessor('mic-capture-processor',MicCaptureProcessor);
`;

// Start mic capture using AudioWorklet (no deprecated ScriptProcessorNode)
async function startAudioCapture(){
    V.audioCtx=new AudioContext({sampleRate:16000});
    V.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16000,channelCount:1,echoCancellation:true,noiseSuppression:true}});
    const source=V.audioCtx.createMediaStreamSource(V.mediaStream);
    // Load mic capture worklet
    const blob=new Blob([MIC_WORKLET_CODE],{type:'application/javascript'});
    const url=URL.createObjectURL(blob);
    try{await V.audioCtx.audioWorklet.addModule(url)}finally{URL.revokeObjectURL(url)}
    V.micWorklet=new AudioWorkletNode(V.audioCtx,'mic-capture-processor');
    // Buffer samples and send in chunks for efficiency
    let pendingSamples=new Float32Array(0);
    const CHUNK_SIZE=4096;
    V.micWorklet.port.onmessage=(e)=>{
        if(e.data.type!=='audio'||!V.active||!S.localWs||S.localWs.readyState!==1)return;
        const samples=e.data.samples;
        const merged=new Float32Array(pendingSamples.length+samples.length);
        merged.set(pendingSamples);merged.set(samples,pendingSamples.length);
        pendingSamples=merged;
        while(pendingSamples.length>=CHUNK_SIZE){
            const chunk=pendingSamples.subarray(0,CHUNK_SIZE);
            pendingSamples=pendingSamples.slice(CHUNK_SIZE);
            const pcm16=new Int16Array(chunk.length);
            for(let i=0;i<chunk.length;i++)pcm16[i]=Math.max(-32768,Math.min(32767,chunk[i]*32768));
            const b64=btoa(String.fromCharCode(...new Uint8Array(pcm16.buffer)));
            S.localWs.send(JSON.stringify({type:'audio_chunk',audio:b64,sample_rate:16000}));
        }
    };
    source.connect(V.micWorklet);V.micWorklet.connect(V.audioCtx.destination);
}

function stopAudioCapture(){
    if(V.micWorklet){V.micWorklet.port.postMessage({type:'stop'});V.micWorklet.disconnect();V.micWorklet=null}
    if(V.processor){V.processor.disconnect();V.processor=null}
    if(V.mediaStream){V.mediaStream.getTracks().forEach(t=>t.stop());V.mediaStream=null}
    if(V.audioCtx&&V.audioCtx.state!=='closed'){V.audioCtx.close().catch(()=>{})}
    V.audioCtx=null;
}

function stopPlayback(){
    if(V.workletNode){V.workletNode.disconnect();V.workletNode=null}
    if(V.playCtx&&V.playCtx.state!=='closed'){V.playCtx.close().catch(()=>{})}
    V.playCtx=null;V.workletReady=false;
}

async function playAudioChunk(b64Audio,sampleRate){
    try{
        if(!V.playCtx||V.playCtx.state==='closed'){
            V.playCtx=new AudioContext({sampleRate});
            const blob=new Blob([AUDIO_WORKLET_CODE],{type:'application/javascript'});
            const url=URL.createObjectURL(blob);
            try{await V.playCtx.audioWorklet.addModule(url);V.workletNode=new AudioWorkletNode(V.playCtx,'audio-processor');V.workletNode.connect(V.playCtx.destination);V.workletReady=true}finally{URL.revokeObjectURL(url)}
        }
        if(!V.workletReady||!V.workletNode)return;
        const bin=atob(b64Audio);const bytes=new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);
        const int16=new Int16Array(bytes.buffer);
        const float32=new Float32Array(int16.length);
        for(let i=0;i<int16.length;i++)float32[i]=int16[i]/32768;
        V.workletNode.port.postMessage({type:'audio',samples:float32});
    }catch(err){console.error('Playback error:',err)}
}

function clearAudioBuffer(){
    if(V.workletNode)V.workletNode.port.postMessage({type:'clear'});
}

// Toggle voice
window.toggleVoice=async function(){
    if(!S.localWs||S.localWs.readyState!==1){toast('Local DevDuck not connected','err');return}

    if(V.active||V.pending){
        // Stop
        V.active=false;V.pending=false;
        S.localWs.send(JSON.stringify({type:'audio_stop'}));
        stopAudioCapture();stopPlayback();
        setVoiceUI('idle');
    }else{
        // Start
        V.pending=true;setVoiceUI('pending');
        try{
            await startAudioCapture();
            const prov=E('voiceProvider')?.value||S.cfg.voiceProvider||'novasonic';
            const voice=E('voiceSelect')?.value||S.cfg.voiceVoice||'';
            S.localWs.send(JSON.stringify({
                type:'audio_start',
                provider:prov,
                voice:voice,
                // Send config for API keys
                geminiKey:S.cfg.geminiKey||'',
                openaiKey:S.cfg.openaiKey||'',
                bedrockRegion:S.cfg.bedrockRegion||'us-east-1',
            }));
            // V.active will be set when we get audio_started back
        }catch(err){
            console.error('Voice start error:',err);
            V.pending=false;stopAudioCapture();
            setVoiceUI('idle');toast('Mic access denied','err');
        }
    }
};

// Hook into local WS messages for voice events
const _origLocalMsgHandler=handleLocalMsgV2;
function handleLocalMsgWithVoice(msg){
    // Handle voice-specific messages
    switch(msg.type){
        case 'audio_started':
            V.active=true;V.pending=false;
            setVoiceUI('active');
            toast('ğŸ¤ Voice active ('+( msg.provider||'?')+')','ok');
            addRing('voice','browser','ğŸ¤ Voice session started ('+( msg.provider||'')+')');
            return;
        case 'audio_stopped':
            V.active=false;V.pending=false;
            stopAudioCapture();stopPlayback();
            setVoiceUI('idle');
            return;
        case 'audio_chunk':
            playAudioChunk(msg.audio,msg.sample_rate||16000);
            return;
        case 'transcript':
            showTranscript(msg.text,msg.role);
            if(msg.is_final){
                const emoji=msg.role==='user'?'ğŸ¤':'ğŸ”Š';
                addRing('voice:'+msg.role,'browser',emoji+' '+msg.text?.slice(0,150));
            }
            return;
        case 'interruption':
            clearAudioBuffer();
            return;
        case 'bidi_connection_start':case 'response_start':case 'response_complete':case 'usage':
            return; // Silently consume bidi lifecycle events
        case 'config_updated':
            return;
    }
    // Pass non-voice messages to original handler
    _origLocalMsgHandler(msg);
}

// Patch local WS to also send config (voice API keys) on connect
const _origConnectLocalPatched=connectLocalPatched;
function connectLocalWithVoice(){
    const port=S.cfg.localPort||10001;
    const ws=new WebSocket(`ws://localhost:${port}`);
    ws.onopen=()=>{
        S.localWs=ws;S.localOk=true;
        registerAgent({id:'local:devduck',type:'local',name:'ğŸ¦† Local DevDuck',status:'ready',description:`ws://localhost:${port}`});
        // Send config with API keys for voice
        ws.send(JSON.stringify({
            type:'config',
            voiceProvider:S.cfg.voiceProvider||'novasonic',
            voice:S.cfg.voiceVoice||'tiffany',
            geminiKey:S.cfg.geminiKey||'',
            openaiKey:S.cfg.openaiKey||'',
            bedrockRegion:S.cfg.bedrockRegion||'us-east-1',
        }));
        updateStatus();updateUI();
    };
    ws.onmessage=e=>{try{const msg=JSON.parse(e.data);handleLocalMsgWithVoice(msg)}catch(err){console.warn('Local WS non-JSON:',e.data?.slice?.(0,100))}};
    ws.onerror=()=>{};
    ws.onclose=()=>{
        S.localOk=false;S.localWs=null;
        if(V.active||V.pending){V.active=false;V.pending=false;stopAudioCapture();stopPlayback();setVoiceUI('idle')}
        const a=S.agents.get('local:devduck');if(a)a.status='offline';
        updateStatus();updateUI();setTimeout(connectLocalWithVoice,5000);
    };
}

// Initialize voice UI
populateVoices();
E('voiceProvider').value=S.cfg.voiceProvider||'novasonic';
populateVoices();
E('voiceCfg').style.display='flex'; // Always show voice config
setVoiceUI('idle');

</script>
</body>
</html>

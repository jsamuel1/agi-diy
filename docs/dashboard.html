<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>agi.diy ‚Äî Mesh Dashboard</title>
<style>
:root {
  --bg: #0a0a0f; --bg-panel: #12121a; --bg-card: #1a1a26; --bg-hover: #22222e;
  --border: #2a2a3a; --text: #e0e0e8; --text-dim: #888898; --text-muted: #555568;
  --accent: #7c5cff; --green: #00ff88; --blue: #00aaff; --pink: #ff88ff;
  --orange: #ffaa00; --red: #ff6666; --cyan: #88ffff;
  --radius: 8px; --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
.app { display: grid; grid-template-columns: 280px 1fr 300px; height: 100vh; }

/* ‚îÄ‚îÄ Left Panel ‚îÄ‚îÄ */
.left-panel { background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.panel-section { padding: 12px; }
.panel-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.panel-title .count { background: var(--bg-card); border-radius: 10px; padding: 1px 7px; font-size: 9px; color: var(--text-dim); }

/* Agents */
.agent-list { display: flex; flex-direction: column; gap: 4px; }
.agent-card { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: var(--radius); cursor: pointer; transition: background .15s; }
.agent-card:hover { background: var(--bg-hover); }
.agent-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.agent-dot.pulse { animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }
.agent-info { flex: 1; min-width: 0; }
.agent-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.agent-model { font-size: 10px; color: var(--text-muted); }
.agent-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: var(--bg); }

/* Tasks */
.task-section { flex: 1; overflow-y: auto; border-top: 1px solid var(--border); }
.task-section::-webkit-scrollbar { width: 4px; }
.task-section::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.task-tree { display: flex; flex-direction: column; gap: 2px; }
.task-item { display: flex; align-items: flex-start; gap: 8px; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: background .15s; border-left: 3px solid transparent; }
.task-item:hover { background: var(--bg-hover); }
.task-item.depth-1 { padding-left: 28px; }
.task-item.depth-2 { padding-left: 46px; }
.task-status { font-size: 12px; flex-shrink: 0; margin-top: 1px; }
.task-info { flex: 1; min-width: 0; }
.task-title { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.task-meta { font-size: 10px; color: var(--text-muted); display: flex; gap: 8px; margin-top: 2px; }
.task-item[data-status="complete"] .task-title { color: var(--text-dim); text-decoration: line-through; }

/* ‚îÄ‚îÄ Center Panel ‚îÄ‚îÄ */
.center-panel { display: flex; flex-direction: column; background: var(--bg); }
.chat-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.chat-header-left { display: flex; align-items: center; gap: 8px; }
.chat-header-title { font-size: 14px; font-weight: 600; }
.chat-header-sub { font-size: 11px; color: var(--text-muted); }
.wall-clock { font-size: 11px; color: var(--accent); font-variant-numeric: tabular-nums; display: flex; align-items: center; gap: 4px; }
.messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.messages::-webkit-scrollbar { width: 4px; }
.messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.msg { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
.msg.user { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
.msg.assistant { align-self: flex-start; background: var(--bg-card); border-bottom-left-radius: 4px; }
.msg .msg-agent { font-size: 10px; font-weight: 600; margin-bottom: 4px; }
.msg .msg-time { font-size: 9px; color: var(--text-muted); margin-top: 4px; text-align: right; }
.input-area { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
.input-area textarea { flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); padding: 10px 12px; font-family: var(--font); font-size: 13px; resize: none; outline: none; min-height: 42px; max-height: 120px; }
.input-area textarea:focus { border-color: var(--accent); }
.send-btn { background: var(--accent); border: none; color: #fff; border-radius: var(--radius); padding: 0 16px; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity .15s; }
.send-btn:hover { opacity: .85; }

/* Task Detail View (hidden by default) */
.task-detail { display: none; flex: 1; overflow-y: auto; padding: 16px; }
.task-detail.active { display: flex; flex-direction: column; gap: 12px; }
.task-detail-header { display: flex; align-items: center; gap: 8px; }
.task-detail-back { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; padding: 4px; }
.task-detail-back:hover { color: var(--text); }
.task-detail-title { font-size: 16px; font-weight: 600; }
.task-detail-status { font-size: 11px; padding: 3px 8px; border-radius: 4px; }
.worklog { display: flex; flex-direction: column; gap: 8px; }
.worklog-entry { padding: 10px 12px; background: var(--bg-card); border-radius: var(--radius); border-left: 3px solid var(--border); }
.worklog-entry .wl-header { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
.worklog-entry .wl-content { font-size: 12px; line-height: 1.5; }

/* ‚îÄ‚îÄ Right Panel ‚îÄ‚îÄ */
.right-panel { background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.ring-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.ring-title { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); }
.ring-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
.ring-clear { background: none; border: none; color: var(--text-muted); font-size: 10px; cursor: pointer; }
.ring-clear:hover { color: var(--text); }
.ring-entries { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px; }
.ring-entries::-webkit-scrollbar { width: 4px; }
.ring-entries::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.ring-entry { padding: 8px 10px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--border); }
.ring-entry .re-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.ring-entry .re-agent { font-size: 11px; font-weight: 600; }
.ring-entry .re-time { font-size: 9px; color: var(--text-muted); }
.ring-entry .re-text { font-size: 11px; color: var(--text-dim); line-height: 1.4; }
.ring-entry.mesh { border-left-color: var(--blue); }

/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media (max-width: 900px) {
  .app { grid-template-columns: 1fr; }
  .left-panel, .right-panel { display: none; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Left Panel: Agents + Tasks -->
  <div class="left-panel">
    <div class="panel-section">
      <div class="panel-title">Agents <span class="count" id="agentCount">0</span></div>
      <div class="agent-list" id="agentList"></div>
    </div>
    <div class="task-section panel-section">
      <div class="panel-title">Tasks <span class="count" id="taskCount">0</span></div>
      <div class="task-tree" id="taskTree"></div>
    </div>
  </div>

  <!-- Center Panel: Chat / Task Detail -->
  <div class="center-panel">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-header-title" id="chatTitle">Chat Agent</div>
        <div class="chat-header-sub" id="chatSub">Haiku ¬∑ ready</div>
      </div>
      <div class="wall-clock" id="wallClock">‚è± 0:00</div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="task-detail" id="taskDetail"></div>
    <div class="input-area">
      <textarea id="chatInput" placeholder="Message the mesh‚Ä¶" rows="1"></textarea>
      <button class="send-btn" id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Right Panel: Ring Buffer -->
  <div class="right-panel">
    <div class="ring-header">
      <div class="ring-title"><span class="ring-dot"></span> Ring Buffer</div>
      <button class="ring-clear" id="ringClear">Clear</button>
    </div>
    <div class="ring-entries" id="ringEntries"></div>
  </div>
</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTION INDEX
// STATE ............. App state, constants, mock data
// RENDER ............ UI rendering functions
// TASK DETAIL ....... Click-to-zoom task detail view
// INIT .............. Startup, event listeners
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const COLORS = ['#00ff88','#00aaff','#ff88ff','#ffaa00','#ff6666','#88ffff'];
const STATUS_ICON = { pending: '‚¨ú', 'in-progress': 'üîµ', waiting: '‚è≥', complete: 'üü¢', failed: 'üî¥' };
const STATUS_LABEL = { pending: 'Pending', 'in-progress': 'In Progress', waiting: 'Waiting', complete: 'Complete', failed: 'Failed' };

const state = {
  agents: new Map(),
  tasks: new Map(),
  ringBuffer: [],
  activeTaskId: null,
  wallClockStart: null,
};

// ‚îÄ‚îÄ Mock Data ‚îÄ‚îÄ
function loadMockData() {
  const agents = [
    { id: 'orchestrator', model: 'Claude Sonnet', status: 'ready', color: COLORS[0] },
    { id: 'researcher', model: 'Claude Haiku', status: 'processing', color: COLORS[1] },
    { id: 'coder', model: 'GPT-4o', status: 'processing', color: COLORS[2] },
    { id: 'reviewer', model: 'WebLLM Qwen 3B', status: 'idle', color: COLORS[3] },
  ];
  agents.forEach(a => state.agents.set(a.id, a));

  const tasks = [
    { id: 't1', title: 'Build Space Minecraft (Browser)', status: 'in-progress', agentId: 'orchestrator', parentId: null, children: ['t1a','t1b','t1c'], worklog: [
      { ts: Date.now()-120000, agentId: 'orchestrator', msg: 'Decomposed into 3 sub-tasks: world gen, player controls, rendering' },
    ]},
    { id: 't1a', title: 'Voxel world generation', status: 'in-progress', agentId: 'coder', parentId: 't1', children: [], worklog: [
      { ts: Date.now()-90000, agentId: 'coder', msg: 'Implementing perlin noise terrain generator in JS' },
      { ts: Date.now()-30000, agentId: 'coder', msg: 'Terrain gen complete, adding biome colors' },
    ]},
    { id: 't1b', title: 'Player movement & controls', status: 'waiting', agentId: null, parentId: 't1', children: [], worklog: [] },
    { id: 't1c', title: 'WebGL rendering pipeline', status: 'pending', agentId: null, parentId: 't1', children: [], worklog: [] },
    { id: 't2', title: 'Triage Slack messages', status: 'in-progress', agentId: 'researcher', parentId: null, children: [], worklog: [
      { ts: Date.now()-60000, agentId: 'researcher', msg: 'Scanning #eng-general, #incidents, #demos ‚Äî 47 unread' },
    ]},
    { id: 't3', title: 'Draft email responses', status: 'pending', agentId: null, parentId: null, children: [], worklog: [] },
    { id: 't4', title: 'Fix auth bug in relay', status: 'complete', agentId: 'coder', parentId: null, children: [], worklog: [
      { ts: Date.now()-300000, agentId: 'coder', msg: 'SigV4 signing was using URLSearchParams ‚Äî switched to manual encoding' },
      { ts: Date.now()-240000, agentId: 'reviewer', msg: 'LGTM, tested against ap-southeast-2 endpoint' },
    ]},
  ];
  tasks.forEach(t => state.tasks.set(t.id, t));

  state.ringBuffer = [
    { agentId: 'orchestrator', content: 'Decomposed "Build Space Minecraft" into 3 parallel sub-tasks', ts: Date.now()-120000 },
    { agentId: 'coder', content: 'Starting voxel world generation with perlin noise', ts: Date.now()-90000 },
    { agentId: 'researcher', content: 'Scanning Slack channels for triage ‚Äî 47 unread messages found', ts: Date.now()-60000 },
    { agentId: 'coder', content: 'Terrain generation complete. Adding biome color mapping.', ts: Date.now()-30000 },
    { agentId: 'orchestrator', content: 'Auth bug fix verified. Moving coder to rendering pipeline next.', ts: Date.now()-10000 },
  ];

  state.wallClockStart = Date.now() - 135000;
}

// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function renderAgents() {
  const el = document.getElementById('agentList');
  document.getElementById('agentCount').textContent = state.agents.size;
  el.innerHTML = [...state.agents.values()].map(a => `
    <div class="agent-card" data-agent="${a.id}">
      <div class="agent-dot ${a.status === 'processing' ? 'pulse' : ''}" style="background:${a.color}"></div>
      <div class="agent-info">
        <div class="agent-name">${a.id}</div>
        <div class="agent-model">${a.model}</div>
      </div>
      <div class="agent-badge" style="color:${a.status === 'processing' ? a.color : 'var(--text-muted)'}">${a.status}</div>
    </div>
  `).join('');
}

function renderTasks() {
  const roots = [...state.tasks.values()].filter(t => !t.parentId);
  document.getElementById('taskCount').textContent = state.tasks.size;
  const html = [];
  function walk(task, depth) {
    const agent = task.agentId ? state.agents.get(task.agentId) : null;
    const color = agent?.color || 'var(--text-muted)';
    html.push(`
      <div class="task-item depth-${depth}" data-task="${task.id}" data-status="${task.status}" style="border-left-color:${color}">
        <span class="task-status">${STATUS_ICON[task.status]}</span>
        <div class="task-info">
          <div class="task-title">${task.title}</div>
          <div class="task-meta">
            ${task.agentId ? `<span style="color:${color}">${task.agentId}</span>` : '<span>unassigned</span>'}
            ${task.worklog.length ? `<span>${task.worklog.length} log${task.worklog.length > 1 ? 's' : ''}</span>` : ''}
          </div>
        </div>
      </div>
    `);
    (task.children || []).forEach(cid => { const c = state.tasks.get(cid); if (c) walk(c, depth + 1); });
  }
  roots.forEach(t => walk(t, 0));
  document.getElementById('taskTree').innerHTML = html.join('');

  document.querySelectorAll('.task-item').forEach(el => {
    el.addEventListener('click', () => showTaskDetail(el.dataset.task));
  });
}

function renderRing() {
  const el = document.getElementById('ringEntries');
  const sorted = [...state.ringBuffer].sort((a, b) => b.ts - a.ts);
  el.innerHTML = sorted.map(e => {
    const agent = state.agents.get(e.agentId);
    const color = agent?.color || '#888';
    const time = new Date(e.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    return `
      <div class="ring-entry" style="border-left-color:${color}">
        <div class="re-header">
          <span class="re-agent" style="color:${color}">${e.agentId}</span>
          <span class="re-time">${time}</span>
        </div>
        <div class="re-text">${e.content.slice(0, 200)}</div>
      </div>
    `;
  }).join('');
}

function renderMessages() {
  const el = document.getElementById('messages');
  el.innerHTML = `
    <div class="msg assistant">
      <div class="msg-agent" style="color:var(--green)">orchestrator</div>
      Ready. I can see 4 agents online. Give me a goal and I'll decompose it into parallel tasks.
      <div class="msg-time">2:15 PM</div>
    </div>
    <div class="msg user">
      Build Space Minecraft two ways, triage Slack, draft my emails, and fix the auth bug in the relay.
      <div class="msg-time">2:15 PM</div>
    </div>
    <div class="msg assistant">
      <div class="msg-agent" style="color:var(--green)">orchestrator</div>
      On it. Created 4 top-level tasks. Assigning coder to Minecraft browser build, researcher to Slack triage. I'll handle decomposition and coordination. Auth bug is already fixed ‚úì
      <div class="msg-time">2:16 PM</div>
    </div>
  `;
  el.scrollTop = el.scrollHeight;
}

// ‚ïê‚ïê‚ïê TASK DETAIL ‚ïê‚ïê‚ïê
function showTaskDetail(taskId) {
  const task = state.tasks.get(taskId);
  if (!task) return;
  state.activeTaskId = taskId;
  const agent = task.agentId ? state.agents.get(task.agentId) : null;
  const color = agent?.color || 'var(--text-muted)';
  const statusColor = { pending: 'var(--text-muted)', 'in-progress': 'var(--blue)', waiting: 'var(--orange)', complete: 'var(--green)', failed: 'var(--red)' };

  const detail = document.getElementById('taskDetail');
  detail.innerHTML = `
    <div class="task-detail-header">
      <button class="task-detail-back" id="taskBack">‚Üê</button>
      <div>
        <div class="task-detail-title">${task.title}</div>
        <div style="display:flex;gap:8px;margin-top:4px;align-items:center">
          <span class="task-detail-status" style="background:${statusColor[task.status]}22;color:${statusColor[task.status]}">${STATUS_ICON[task.status]} ${STATUS_LABEL[task.status]}</span>
          ${task.agentId ? `<span style="font-size:11px;color:${color}">‚¨§ ${task.agentId}</span>` : '<span style="font-size:11px;color:var(--text-muted)">unassigned</span>'}
        </div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:8px">Worklog</div>
    <div class="worklog">
      ${task.worklog.length ? task.worklog.map(w => {
        const wa = state.agents.get(w.agentId);
        const wc = wa?.color || '#888';
        return `<div class="worklog-entry" style="border-left-color:${wc}">
          <div class="wl-header">
            <span style="color:${wc}">${w.agentId}</span>
            <span>${new Date(w.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
          </div>
          <div class="wl-content">${w.msg}</div>
        </div>`;
      }).join('') : '<div style="font-size:12px;color:var(--text-muted);padding:12px">No worklog entries yet</div>'}
    </div>
  `;

  document.getElementById('messages').style.display = 'none';
  detail.classList.add('active');
  document.getElementById('taskBack').addEventListener('click', hideTaskDetail);
}

function hideTaskDetail() {
  state.activeTaskId = null;
  document.getElementById('taskDetail').classList.remove('active');
  document.getElementById('messages').style.display = 'flex';
}

// ‚ïê‚ïê‚ïê WALL CLOCK ‚ïê‚ïê‚ïê
function updateWallClock() {
  if (!state.wallClockStart) return;
  const elapsed = Math.floor((Date.now() - state.wallClockStart) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  document.getElementById('wallClock').textContent = `‚è± ${m}:${String(s).padStart(2, '0')}`;
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
loadMockData();
renderAgents();
renderTasks();
renderRing();
renderMessages();
setInterval(updateWallClock, 1000);
updateWallClock();

// Auto-resize textarea
const input = document.getElementById('chatInput');
input.addEventListener('input', () => { input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px'; });
input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); /* Phase 2: sendMessage() */ } });
</script>
</body>
</html>
